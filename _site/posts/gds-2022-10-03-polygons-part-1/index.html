<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.537">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sebastiano Ferraris">
<meta name="dcterms.date" content="2022-10-03">

<title>A Geospatial Data Science Blog - Using polygons</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../about/images/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="A Geospatial Data Science Blog - Using polygons">
<meta name="twitter:description" content="Geospatial data science basic operations and measurements">
<meta name="twitter:image" content="images/cover.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Geospatial Data Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-posts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Posts</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-posts">    
        <li>
    <a class="dropdown-item" href="../../posts/index.html">
 <span class="dropdown-text">All posts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/index_gds.html">
 <span class="dropdown-text">Geospatial Data Science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/index_bp.html">
 <span class="dropdown-text">Code development</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../../about/about.html">
 <span class="dropdown-text">Blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../about/CV_modern/curriculum.pdf">
 <span class="dropdown-text">CV</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Using polygons</h1>
            <p class="subtitle lead">Geospatial data science basic operations and measurements</p>
                                <div class="quarto-categories">
                <div class="quarto-category">tutorial</div>
                <div class="quarto-category">data-science</div>
                <div class="quarto-category">geospatial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Sebastiano Ferraris </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 3, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#using-polygons-in-geospatial-data-science-basic-operations-and-measurements" id="toc-using-polygons-in-geospatial-data-science-basic-operations-and-measurements" class="nav-link active" data-scroll-target="#using-polygons-in-geospatial-data-science-basic-operations-and-measurements">Using polygons in geospatial data science: basic operations and measurements</a>
  <ul class="collapse">
  <li><a href="#topics-of-this-part-and-the-next-two" id="toc-topics-of-this-part-and-the-next-two" class="nav-link" data-scroll-target="#topics-of-this-part-and-the-next-two">Topics of this part and the next two</a></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment">Setting up the environment</a></li>
  <li><a href="#polygons-intersecting-water-and-land" id="toc-polygons-intersecting-water-and-land" class="nav-link" data-scroll-target="#polygons-intersecting-water-and-land">Polygons intersecting water and land</a></li>
  <li><a href="#polygons-intersecting-water-and-land-nearby" id="toc-polygons-intersecting-water-and-land-nearby" class="nav-link" data-scroll-target="#polygons-intersecting-water-and-land-nearby">Polygons intersecting water and land… nearby!</a></li>
  <li><a href="#distances-between-countries" id="toc-distances-between-countries" class="nav-link" data-scroll-target="#distances-between-countries">Distances between countries</a></li>
  <li><a href="#same-country-different-borders-how-different-are-they" id="toc-same-country-different-borders-how-different-are-they" class="nav-link" data-scroll-target="#same-country-different-borders-how-different-are-they">Same country, different borders: how different are they?</a>
  <ul class="collapse">
  <li><a href="#dices-score" id="toc-dices-score" class="nav-link" data-scroll-target="#dices-score">Dice’s Score</a></li>
  <li><a href="#dices-distance" id="toc-dices-distance" class="nav-link" data-scroll-target="#dices-distance">Dice’s Distance</a></li>
  <li><a href="#covariance-distance" id="toc-covariance-distance" class="nav-link" data-scroll-target="#covariance-distance">Covariance Distance</a></li>
  <li><a href="#hausdoroff-distance" id="toc-hausdoroff-distance" class="nav-link" data-scroll-target="#hausdoroff-distance">Hausdoroff Distance</a></li>
  <li><a href="#normalised-symmetric-contour-distance" id="toc-normalised-symmetric-contour-distance" class="nav-link" data-scroll-target="#normalised-symmetric-contour-distance">Normalised Symmetric Contour distance</a></li>
  </ul></li>
  <li><a href="#appendix-list-of-topics-and-further-theoretical-ideas" id="toc-appendix-list-of-topics-and-further-theoretical-ideas" class="nav-link" data-scroll-target="#appendix-list-of-topics-and-further-theoretical-ideas">Appendix: list of topics and further theoretical ideas</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  <li><a href="#inspired-by" id="toc-inspired-by" class="nav-link" data-scroll-target="#inspired-by">Inspired by</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><img src="images/cover.png" class="img-fluid"></p>
<p><em>This article was first published on the 10 October 2022 on <a href="https://geods.hashnode.dev">geods.hashnode.dev</a>. The version presented here is the maintained one.</em></p>
<section id="using-polygons-in-geospatial-data-science-basic-operations-and-measurements" class="level1">
<h1>Using polygons in geospatial data science: basic operations and measurements</h1>
<p>In this article, the first of a series of three, you will find a few facts and examples about an ubiquitous object lying at the very foundation of geospatial data science: nothing less than the polygon!</p>
<p>Wether used to segment raster data, such as satellite images or regular point grids, or in conjunction with other vectorial objects, such as points and lines, polygons are geometrical figures omnipresent in almost every operations and measurements involving maps. Knowing how to manipulate polygons quickly is one of the things telling apart the pro data scientist from the rest.</p>
<p>In their simplicity, the power of polygons lies in being a general purpose model for anything that has a surface, and in their extensibility, via associating meta-data or features, as a lists of attributes with collected data in relation to the modelled surface.</p>
<p>For example to know where to place a bus stop, roads become segments, existing bus stops become points, and neighborhoods become polygons; to each of these entities we can associate the collected data, that can be static such as lengths, average traveling time, population density, building typology, such as offices, residential or shops, with their capacity, as well as dynamics such as temporal series of traffic, flow of people, opening and closing time etc… We can even consider moving polygons, to model icebergs, or shrinking and expanding polygons to model rivers and lakes.</p>
<p>Simplifying the model and selecting the optimal attributes to the geometries involved, is the step that would make most of the subsequent analysis straightforward, pending the ability to manipulate and measure the objects involved.</p>
<p>There are in fact a series of experimental or at least intuitive facts about polygons, and some slightly less intuitive, such as how to measure the distance between two polygons on a surface (and on a curved surface), or how to measure the overlap of two polygons, or the difference between two polygons aimed at modelling the same object.</p>
<p>In wanting to keep a pragmatic approach to the matter, we will omit the even less intuitive measures entailing the pathological cases of polygons, such as fractals and limits of curves in general, that rarely arise in the practice of geospatial data science.</p>
<section id="topics-of-this-part-and-the-next-two" class="level2">
<h2 class="anchored" data-anchor-id="topics-of-this-part-and-the-next-two">Topics of this part and the next two</h2>
<p>This is the first article of a series of three. The topics covered in the three parts are:</p>
<ul>
<li>Part 1: <strong>Definitions: intersections, operations and measurements of polygons</strong>
<ul>
<li><strong>Polygons intersecting water and land.</strong></li>
<li><strong>…and with water and land nearby.</strong></li>
<li><strong>Which country intersect this polygon?</strong></li>
<li><strong>Distances between countries.</strong></li>
<li><strong>Same country, different borders: how different are they?</strong></li>
</ul></li>
<li>Part 2: Reference systems for polygons
<ul>
<li>Changing reference system</li>
<li>Polygons crossing the antimeridian</li>
<li>What at the poles.</li>
</ul></li>
<li>Part 3: Random polygons and wandering polygons
<ul>
<li>Creating random polygons</li>
<li>Floating polygons</li>
<li>Polygons deformed by a vector field</li>
</ul></li>
</ul>
</section>
<section id="setting-up-the-environment" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-environment">Setting up the environment</h2>
<p>Create a python 3.9 environment called <code>venv</code> and activate it. There are several options, the code below is to create an environment via virtualenv, as quicker than conda, and more than enough for these small experiments:</p>
<pre><code>virtualenv venv -p python3.9
source venv/bin/activate</code></pre>
<p>With the environment activated, install the requirements below. You can install each library individually with pip <code>pip install &lt;copy paste each line here&gt;</code>, or you can copy paste all the requirements in a file in the root of your project <code>requirements.txt</code> and install them all in one go via <code>pip install -r requirements.txt</code>.</p>
<pre><code># requirements.txt
geopandas==0.11.1
jupyter==1.0.0
keplergl==0.3.2
matplotlib==3.6.0
osmnx==1.2.2
shapely==1.8.4</code></pre>
</section>
<section id="polygons-intersecting-water-and-land" class="level2">
<h2 class="anchored" data-anchor-id="polygons-intersecting-water-and-land">Polygons intersecting water and land</h2>
<p>Land and water on a map are typically modelled by polygons through the segmentation of the underlying geographical features.</p>
<p>Given a polygon or a bounding box drawn on a map as input, the goal is to answer the question</p>
<blockquote class="blockquote">
<p>What is the percentage of land and water that the polygon drawn on the map intersects?</p>
</blockquote>
<p>For the example below we will use a polygon drawn around the city of Genova, Italy, (44.405551, 8.904023). As usual you are invited to reproduce the results using a different city.</p>
<div id="cell-3" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy <span class="im">import</span> distance</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">DeprecationWarning</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy <span class="im">import</span> distance</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keplergl <span class="im">import</span> KeplerGl</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Polygon, Point, shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>KEPLER_OUTPUT <span class="op">=</span> <span class="va">False</span>  <span class="co"># Render kepler output if True. Produces a screenshot for the blog article otherwise</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    map_0 <span class="op">=</span> KeplerGl(height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    display(map_0)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map0.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In an interactive session the cell above produces creates an empty map where to draw a polygon and copy paste it in the cell below. In the static blog version this is not reproduced, as the variable <code>KEPLER_OUTPUT</code> is set to <code>False</code>.</p>
<p>You can get at the source notebook used to create this blog post and create a different polygon, using the drawing pencil (top right), then right click on it to copy the values and paste it in a dictionary.</p>
<div id="cell-7" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dict_roi <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="fl">8.987382009236233</span>,<span class="fl">44.54680601507832</span>],[<span class="fl">8.841126105836173</span>,<span class="fl">44.550231465826634</span>],[<span class="fl">8.723022747221052</span>,<span class="fl">44.53065474626796</span>],[<span class="fl">8.621398927017932</span>,<span class="fl">44.48511343018655</span>],[<span class="fl">8.591873087363503</span>,<span class="fl">44.3865638718846</span>],[<span class="fl">8.64817817693631</span>,<span class="fl">44.307506289856086</span>],[<span class="fl">8.75666847147733</span>,<span class="fl">44.33796344890003</span>],[<span class="fl">8.83906616353428</span>,<span class="fl">44.35613196160054</span>],[<span class="fl">8.950989695244745</span>,<span class="fl">44.3531860988552</span>],[<span class="fl">9.023087675794352</span>,<span class="fl">44.30554076888227</span>],[<span class="fl">9.079392765366244</span>,<span class="fl">44.274083482671955</span>],[<span class="fl">9.120591611394707</span>,<span class="fl">44.288339652995674</span>],[<span class="fl">9.143937624144632</span>,<span class="fl">44.33108740800724</span>],[<span class="fl">9.141877681842741</span>,<span class="fl">44.39784910785984</span>],[<span class="fl">9.090379124307875</span>,<span class="fl">44.49344084451141</span>],[<span class="fl">8.987382009236233</span>,<span class="fl">44.54680601507832</span>]]]}</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>sh_roi <span class="op">=</span> shape(dict_roi)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>config_map1 <span class="op">=</span> {</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'version'</span>: <span class="st">'v1'</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'config'</span>: {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mapState'</span>: {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bearing"</span>: <span class="dv">0</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"dragRotate"</span>: <span class="va">False</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"latitude"</span>: <span class="fl">44.41404004333898</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"longitude"</span>: <span class="fl">8.871549089955757</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pitch"</span>: <span class="dv">0</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"zoom"</span>: <span class="fl">10.347869665266995</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"isSplit"</span>: <span class="va">False</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>gdf_roi <span class="op">=</span>  gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"ROI"</span>], <span class="st">"geometry"</span>: [sh_roi]})</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>gdf_roi <span class="op">=</span> gdf_roi.set_crs(<span class="st">'4326'</span>)  <span class="co"># reproject to WGS84 (the only one supported by kepler)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># To reproduce exactly the same images shown in the article you will have to copy the config</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># file from the linked repo and save it in the save it in a configs.py file.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># You can still follow the tutorial and run all the lines of code without the config.</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map1</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    config_map1 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    map_1 <span class="op">=</span> KeplerGl(data<span class="op">=</span>deepcopy({<span class="st">"roi"</span>: gdf_roi}), config<span class="op">=</span>config_map1, height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    display(map_1)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map1.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The copy pasted geometry from the kepler app is a dictionary with a type and a list of coordinates following a conventional GeoJSON object. GeoJSON is a format for encoding data about geographic features using JavaScript Object Notation (json), established in 2015.</p>
<p>A <a href="https://geojson.org/">geojson</a> to model a single point appears as:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Feature"</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"geometry"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"Point"</span><span class="fu">,</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"coordinates"</span><span class="fu">:</span> <span class="ot">[</span><span class="fl">125.6</span><span class="ot">,</span> <span class="fl">10.1</span><span class="ot">]</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"properties"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Dinagat Islands"</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where <code>"type"</code> can be <code>Feature</code> for single objects, or <code>FeatureCollections</code> for multiple objects, and where the <code>geometry.type</code> can be a <code>Point</code>, <code>LineString</code>, <code>Polygon</code>, <code>MultiPoint</code>, <code>MultiLineString</code>, and <code>MultiPolygon</code>.</p>
<p>To get the “water” within the selected geometry, we will use the <code>osmnx</code> library.</p>
<p>There are a few options to obtain land and water intersecting a region. It is possible to get the rivers, the sea (or bay), and the administrative regions and then consider to subtract the rivers to the administrative regions, and their intersection with the selected ROI. This option may leave some empty spaces, as in OSM there may be multiple annotators and the boundaries may not collimate. A different approach is to assume that all what is not water is land. So we query the rivers and the sea, we consider their union and their intersection with the ROI, and we call this new region “water”. The land will be the set difference between water and the ROI.</p>
<p><span class="math display">\[
\text{water}_{\text{roi}} = (\text{sea} \cup \text{river}) \cap \text{roi}\\
\text{land}_{\text{roi}} = \text{roi} \setminus \text{water}_{\text{roi}}
\]</span></p>
<p>So we need to perform the binary polygon operations of union, intersection and subtraction of polygons, as well as to get the polygons of sea and rivers involved in the selected roi.</p>
<div id="cell-10" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how to get tags:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://wiki.openstreetmap.org/wiki/Map_features#Water_related</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ~5 mins the first run (2 seconds after the first run, as results are stored in the local folder `cache`).</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>gdf_rivers <span class="op">=</span> osmnx.geometries_from_polygon(sh_roi, tags<span class="op">=</span>{<span class="st">'natural'</span>: <span class="st">'water'</span>})</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>gdf_sea <span class="op">=</span> osmnx.geometries_from_polygon(sh_roi, tags<span class="op">=</span>{<span class="st">'natural'</span>: <span class="st">'bay'</span>})</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check crs is already set to WGS84</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_rivers.crs <span class="op">==</span> <span class="dv">4326</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_sea.crs <span class="op">==</span> <span class="dv">4326</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dissolve the "geodataframe" so that all of its rows are conflated into a single observation</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>gdf_rivers <span class="op">=</span> gdf_rivers.dissolve()</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>gdf_sea <span class="op">=</span> gdf_sea.dissolve()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute water_roi and land_roi</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>gse_sea_union_river <span class="op">=</span> gdf_rivers.union(gdf_sea)  <span class="co"># The union of two geodataframes is a geoseries (the union is only on the geometries)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>gse_water_roi <span class="op">=</span> gse_sea_union_river.intersection(gdf_roi)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>gse_land_roi <span class="op">=</span> gdf_roi.difference(gse_water_roi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>you can also explore the administrative boundaries for an alternative route to find the polygons segmenting land.</p>
<pre><code>gdf_region = ox.geometries_from_polygon(sh_poly, tags={'boundary': 'administrative'})</code></pre>
<p>But this route is not explored here, you are invited to investigate and plot it.</p>
<div id="cell-12" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Call deepcopy when passing an object prevents issue "AttributeError: 'str' object has no attribute '_geom'".</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/keplergl/kepler.gl/issues/1240</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>gdf_genova <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: [<span class="st">"roi"</span>, <span class="st">"water"</span>, <span class="st">"land"</span>], </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"geometry"</span>:[deepcopy(gdf_roi.geometry.iloc[<span class="dv">0</span>]), deepcopy(gse_water_roi.iloc[<span class="dv">0</span>]), deepcopy(gse_land_roi.iloc[<span class="dv">0</span>])]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>gdf_genova <span class="op">=</span> gdf_genova.set_crs(<span class="st">'4326'</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>display(gdf_genova.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>roi</td>
<td>POLYGON ((8.98738 44.54681, 8.84113 44.55023, ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>water</td>
<td>MULTIPOLYGON (((8.62514 44.37508, 8.62505 44.3...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>land</td>
<td>MULTIPOLYGON (((8.98738 44.54681, 9.04759 44.5...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>kepler_data <span class="op">=</span> {}</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> gdf_genova.iterrows():</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    kepler_data.update({row[<span class="st">"name"</span>]: gdf_genova[gdf_genova[<span class="st">"name"</span>] <span class="op">==</span> row[<span class="st">"name"</span>]].copy()})</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map2</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    config_map2 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    map_2 <span class="op">=</span> KeplerGl(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>deepcopy(kepler_data), </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>config_map2,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    display(map_2)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map2.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to cylindrical equal area projectcion</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gdf_genova[<span class="st">"areas (Km2)"</span>] <span class="op">=</span> gdf_genova.to_crs({<span class="st">'proj'</span>:<span class="st">'cea'</span>}).area<span class="op">/</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>display(gdf_genova[[<span class="st">"name"</span>, <span class="st">"areas (Km2)"</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">areas (Km2)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>roi</td>
<td>920.966148</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>water</td>
<td>330.635071</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>land</td>
<td>590.333976</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="polygons-intersecting-water-and-land-nearby" class="level2">
<h2 class="anchored" data-anchor-id="polygons-intersecting-water-and-land-nearby">Polygons intersecting water and land… nearby!</h2>
<p>There are situations when the manually delineated region may not be as accurate as it is required. It may be required to get some information of the areas “nearby” as well. “Nearby” can have different definitions, and here we get three of them: 1. Convex hull 2. Bounding Box 3. Buffer</p>
<p>The convex hull of the polygon <span class="math inline">\(\Omega\)</span> is the smallest convex polygon containing <span class="math inline">\(\Omega\)</span>. The bounding box is the smallest rectangle containing <span class="math inline">\(\Omega\)</span> with edges parallel to the axis of the reference system. The buffer consists of enlarging the boundaries of <span class="math inline">\(\Omega\)</span> in a direction perpendicular to its sides. The analogous operation for raster objects is called <em>dilation</em> and it is one of the two most common morphological operations along with <em>erosion</em>.</p>
<p>But first we transform the operations we wrote so far into a function, taking <code>dict_roi</code> as input and returning the equivalent of <code>gdf_genova</code> for the selected area, which we can try for a different geometry. Then we test that the functions work for a different region. We chose the Viverone Lake, you are invited to select another one.</p>
<div id="cell-16" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> water_and_land(roi: <span class="bu">dict</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""from a polygon embedded in a geojson dict to a geodataframe with water, land and respective areas"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    sh_roi <span class="op">=</span> shape(roi)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    gdf_roi <span class="op">=</span>  gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"ROI"</span>], <span class="st">"geometry"</span>: [sh_roi]}).set_crs(<span class="st">'4326'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    gdf_rivers <span class="op">=</span> osmnx.geometries_from_polygon(sh_roi, tags<span class="op">=</span>{<span class="st">'natural'</span>: <span class="st">'water'</span>}).dissolve()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    gdf_sea <span class="op">=</span> osmnx.geometries_from_polygon(sh_roi, tags<span class="op">=</span>{<span class="st">'natural'</span>: <span class="st">'bay'</span>}).dissolve()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    gse_sea_union_river <span class="op">=</span> gdf_rivers.union(gdf_sea) <span class="cf">if</span> <span class="bu">len</span>(gdf_sea) <span class="cf">else</span> gdf_rivers</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    gse_water_roi <span class="op">=</span> gse_sea_union_river.intersection(gdf_roi)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    gse_land_roi <span class="op">=</span> gdf_roi.difference(gse_water_roi)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"name"</span>: [<span class="st">"roi"</span>, <span class="st">"water"</span>, <span class="st">"land"</span>], </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"geometry"</span>:[deepcopy(gdf_roi.geometry.iloc[<span class="dv">0</span>]), deepcopy(gse_water_roi.iloc[<span class="dv">0</span>]), deepcopy(gse_land_roi.iloc[<span class="dv">0</span>])]</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    ).set_crs(<span class="st">'4326'</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">"areas (Km2)"</span>] <span class="op">=</span> gdf.to_crs({<span class="st">'proj'</span>:<span class="st">'cea'</span>}).area<span class="op">/</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_gdf_to_layers(gdf: gpd.GeoDataFrame, column_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"name"</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    kepler_data <span class="op">=</span> {}</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> gdf.iterrows():</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        kepler_data.update({row[column_name]: gdf[gdf[column_name] <span class="op">==</span> row[column_name]].copy()})</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kepler_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map3</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    config_map3 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">True</span>:</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    dict_viverone <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="fl">8.098304589093475</span>,<span class="fl">45.44917237554611</span>],[<span class="fl">8.061826507846979</span>,<span class="fl">45.42337850571526</span>],[<span class="fl">8.086238762219843</span>,<span class="fl">45.3926467614535</span>],[<span class="fl">8.015246804101336</span>,<span class="fl">45.37550064157892</span>],[<span class="fl">7.985783738478874</span>,<span class="fl">45.42121207166915</span>],[<span class="fl">8.02282302097566</span>,<span class="fl">45.44838495097526</span>],[<span class="fl">8.098304589093475</span>,<span class="fl">45.44917237554611</span>]]]}</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ~ 5 minutes first run - data are downloaded and cached</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    map_3 <span class="op">=</span> KeplerGl(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>deepcopy(split_gdf_to_layers(water_and_land(dict_viverone))), </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span>config_map3,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    display(map_3)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map3.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we can consider the three “nearby” operations. For simplicity all the three operations we are interested in are embedded in a class.</p>
<div id="cell-19" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GeoOperations:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _data_to_gdf(roi: <span class="bu">dict</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" input value `data` is a dumped geojson to a string format """</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        sh_roi <span class="op">=</span> shape(roi)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"ROI"</span>], <span class="st">"geometry"</span>: [sh_roi]}).set_crs(<span class="dv">4326</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _add_area_column(gdf: gpd.GeoDataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">"areas (Km2)"</span>] <span class="op">=</span> gdf.to_crs({<span class="st">'proj'</span>:<span class="st">'cea'</span>}).area<span class="op">/</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_polygon_box(row):</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        c_hull <span class="op">=</span> row.convex_hull  <span class="co"># make sure the input is a polygon </span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        x, y, X, Y <span class="op">=</span> c_hull.bounds</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shapely.geometry.Polygon([(x, y), (X, y), (X, Y), (x, Y), (x, y)])</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">buffer</span>(<span class="va">self</span>, data: <span class="bu">str</span>, buffer_meters:<span class="bu">float</span> <span class="op">=</span> <span class="dv">10</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> <span class="va">self</span>._data_to_gdf(data)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        gdf.geometry <span class="op">=</span> gdf.to_crs(crs<span class="op">=</span><span class="dv">3857</span>)[<span class="st">'geometry'</span>].<span class="bu">buffer</span>(buffer_meters).to_crs(<span class="dv">4326</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._add_area_column(gdf)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gdf</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> convex_hull(<span class="va">self</span>, data: <span class="bu">str</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> <span class="va">self</span>._data_to_gdf(data)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        gdf.geometry <span class="op">=</span> gdf[<span class="st">'geometry'</span>].convex_hull</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._add_area_column(gdf)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gdf</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bbox(<span class="va">self</span>, data: <span class="bu">str</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> <span class="va">self</span>._data_to_gdf(data)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf[<span class="st">'geometry'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="va">self</span>._get_polygon_box(x))</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._add_area_column(gdf)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>kepler_data <span class="op">=</span> split_gdf_to_layers(water_and_land(dict_roi))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>ge_ops <span class="op">=</span> GeoOperations()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>kepler_data.update({<span class="st">"buffer"</span>: ge_ops.<span class="bu">buffer</span>(dict_roi, <span class="dv">5_000</span>), <span class="st">"convex hull"</span>: ge_ops.convex_hull(dict_roi), <span class="st">"bbox"</span>: ge_ops.bbox(dict_roi)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map4</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    config_map4 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    map_4 <span class="op">=</span> KeplerGl(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>deepcopy(kepler_data),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>deepcopy(config_map4),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    map_4</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map4.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In the picture above the bounding box, buffer and convex hull were added to the selected geometry, but the land and sea was not computed for these new polygons. This is left for the reader for practice. For example the water and land within the bounding box should look like the figure below:</p>
<div id="cell-23" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dict_bbox <span class="op">=</span> ge_ops.bbox(dict_roi)[<span class="st">"geometry"</span>].iloc[<span class="dv">0</span>].__geo_interface__</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    map_5 <span class="op">=</span> KeplerGl(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>split_gdf_to_layers(water_and_land(dict_bbox)), </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>deepcopy(config_map4), <span class="co"># we can re-use the same config as the previous map</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    map_5</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map5.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>1.3 Which country intersects this polygon?</p>
<p>Imagine now to draw a polygon on the map with the goal of solving the following problem:</p>
<blockquote class="blockquote">
<p>Get the list with the names of all the countries intersecting the given polygon.</p>
</blockquote>
<p>There are two options we can see think of to solve this problem with <code>osmnx</code>: 1. Create a GeoDataFrame in memory with all the countries in the world, and then compute the intersection between the dataframe and the given polygon. 2. Feed the given polygon to osmnx directly, and use the right tag to get all the countries intersecting it.</p>
<p>The first one is very slow to initialise, though fast each time a new polygon is passed to the <code>intersect</code> method. The second one is relatively slow each time a new polygon is given.</p>
<p>Here, out of laziness we will not use any of the methods above. The toy dataset provided <code>geopandas</code> contains already all the information that we need, so we will use this one instead of the one provided by osmnx.</p>
<p>As usual the first step is to draw a polygon on the first empty map of the notebook. Then copy paste the polygon geojson below, to be saved in the variable <code>dict_roi</code>. We selected a rectangular region around Myanmar, the reader is free to act according to preference.</p>
<div id="cell-25" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dict_roi <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="fl">95.27405518168942</span>,<span class="fl">28.464895473156595</span>],[<span class="fl">88.19328456832459</span>,<span class="fl">26.69900877882346</span>],[<span class="fl">87.15109322263424</span>,<span class="fl">21.154320639876016</span>],[<span class="fl">91.6876908450501</span>,<span class="fl">14.831845554981104</span>],[<span class="fl">98.52323996531177</span>,<span class="fl">13.52423467533735</span>],[<span class="fl">103.97941818686449</span>,<span class="fl">15.157545455928199</span>],[<span class="fl">104.43920848643478</span>,<span class="fl">20.868173454079436</span>],[<span class="fl">104.0713762467781</span>,<span class="fl">26.45228108415989</span>],[<span class="fl">95.27405518168942</span>,<span class="fl">28.464895473156595</span>]]]}</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>sh_roi <span class="op">=</span> shape(dict_roi)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>gdf_roi <span class="op">=</span>  gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"ROI"</span>], <span class="st">"geometry"</span>: [sh_roi]})</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>gdf_roi <span class="op">=</span> gdf_roi.set_crs(<span class="st">'4326'</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map6</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    config_map6 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    map_6 <span class="op">=</span> KeplerGl(data<span class="op">=</span>deepcopy({<span class="st">"roi"</span>: gdf_roi}), height<span class="op">=</span><span class="dv">800</span>, config<span class="op">=</span>config_map6)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    display(map_6)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map6.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>gdf_countries <span class="op">=</span> gpd.read_file(gpd.datasets.get_path(<span class="st">'naturalearth_lowres'</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>gdf_countries[<span class="st">"areas (Km2)"</span>] <span class="op">=</span> gdf_countries.to_crs({<span class="st">'proj'</span>:<span class="st">'cea'</span>}).area<span class="op">/</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> gdf_countries.plot(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">15</span>), column<span class="op">=</span><span class="st">'areas (Km2)'</span>, cmap<span class="op">=</span><span class="st">'Greens'</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)  <span class="co"># images/map_naturalearth.png</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>dict_roi <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="fl">95.27405518168942</span>,<span class="fl">28.464895473156595</span>],[<span class="fl">88.19328456832459</span>,<span class="fl">26.69900877882346</span>],[<span class="fl">87.15109322263424</span>,<span class="fl">21.154320639876016</span>],[<span class="fl">91.6876908450501</span>,<span class="fl">14.831845554981104</span>],[<span class="fl">98.52323996531177</span>,<span class="fl">13.52423467533735</span>],[<span class="fl">103.97941818686449</span>,<span class="fl">15.157545455928199</span>],[<span class="fl">104.43920848643478</span>,<span class="fl">20.868173454079436</span>],[<span class="fl">104.0713762467781</span>,<span class="fl">26.45228108415989</span>],[<span class="fl">95.27405518168942</span>,<span class="fl">28.464895473156595</span>]]]}</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>sh_roi <span class="op">=</span> shape(dict_roi)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># note gdf_countries.intersects(sh_roi) returns a boolean series.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>gdf_intersection_countries <span class="op">=</span> gdf_countries[gdf_countries.intersects(sh_roi)].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>gdf_intersection_countries[[<span class="st">"name"</span>, <span class="st">'areas (Km2)'</span>]].head(<span class="dv">10</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>display(gdf_intersection_countries.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pop_est</th>
<th data-quarto-table-cell-role="th">continent</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">iso_a3</th>
<th data-quarto-table-cell-role="th">gdp_md_est</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">areas (Km2)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>68414135</td>
<td>Asia</td>
<td>Thailand</td>
<td>THA</td>
<td>1161000.0</td>
<td>POLYGON ((105.21878 14.27321, 104.28142 14.416...</td>
<td>5.101229e+05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7126706</td>
<td>Asia</td>
<td>Laos</td>
<td>LAO</td>
<td>40960.0</td>
<td>POLYGON ((107.38273 14.20244, 106.49637 14.570...</td>
<td>2.290354e+05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>55123814</td>
<td>Asia</td>
<td>Myanmar</td>
<td>MMR</td>
<td>311100.0</td>
<td>POLYGON ((100.11599 20.41785, 99.54331 20.1866...</td>
<td>6.795988e+05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>96160163</td>
<td>Asia</td>
<td>Vietnam</td>
<td>VNM</td>
<td>594900.0</td>
<td>POLYGON ((104.33433 10.48654, 105.19991 10.889...</td>
<td>3.360194e+05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1281935911</td>
<td>Asia</td>
<td>India</td>
<td>IND</td>
<td>8721000.0</td>
<td>POLYGON ((97.32711 28.26158, 97.40256 27.88254...</td>
<td>3.142772e+06</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Left to the reader is to add a column with the information of the the percentage of the area covered by the selected roi over each country (e.g.&nbsp;Myanmar will be 100% covered by the ROI. What about China?).</p>
</section>
<section id="distances-between-countries" class="level2">
<h2 class="anchored" data-anchor-id="distances-between-countries">Distances between countries</h2>
<p>Now let’s say you have two polygons representing two countries. How to compute their distance in Km on the surface of the earth?</p>
<div id="cell-30" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>list_countries <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(gdf_countries.name))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>list_countries[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>['Afghanistan',
 'Albania',
 'Algeria',
 'Angola',
 'Antarctica',
 'Argentina',
 'Armenia',
 'Australia',
 'Austria',
 'Azerbaijan']</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gdf_countries.to_crs(epsg<span class="op">=</span><span class="dv">27700</span>,inplace<span class="op">=</span><span class="va">True</span>) <span class="co"># more about 27700 on the next article! The impatient reader can look under https://epsg.io/27700</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>sh_france <span class="op">=</span> gdf_countries[gdf_countries.name <span class="op">==</span> <span class="st">"France"</span>].geometry.iloc[<span class="dv">0</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>sh_italy <span class="op">=</span> gdf_countries[gdf_countries.name <span class="op">==</span> <span class="st">'Italy'</span>].geometry.iloc[<span class="dv">0</span>]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>sh_uk <span class="op">=</span> gdf_countries[gdf_countries.name <span class="op">==</span> <span class="st">'United Kingdom'</span>].geometry.iloc[<span class="dv">0</span>]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Distance between France and UK polygons: </span><span class="sc">{</span><span class="bu">round</span>(sh_france.distance(sh_uk) <span class="op">/</span> <span class="dv">1_000</span>, <span class="dv">3</span>)<span class="sc">}</span><span class="ss"> Km"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance between France and UK polygons: 37.14 Km</code></pre>
</div>
</div>
<p>A quick investigation using google seems to not confirm this number. Google says the distance is approx 32Km. Did we do something wrong? Let’s use google maps and pick the two point that are visually the closest to each others on the coasts, copy paste them to the notebook and see what is their distance:</p>
<div id="cell-33" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> (<span class="fl">51.108648</span>, <span class="fl">1.286524</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> (<span class="fl">50.869575</span>, <span class="fl">1.583608</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Distance between France and UK by naked eye: </span><span class="sc">{</span><span class="bu">round</span>(distance.distance(a, b).km, <span class="dv">3</span>)<span class="sc">}</span><span class="ss"> Km"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance between France and UK by naked eye: 33.801 Km</code></pre>
</div>
</div>
<p>This number looks way closer to the one found with the shapely <code>distance</code> method. So Why the discrepancy? Is it a problem with the coordinates? Maybe the <code>27700</code> is not the optimal one in this case?</p>
<p>Looking at the data we can find that the accuracy of the countries segmentation is way less that the actual underlying coast. The accuracy is so low that the distance between the polygon is actually wider!</p>
<div id="cell-35" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map7</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    config_map7 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    map_7 <span class="op">=</span> KeplerGl(data<span class="op">=</span>deepcopy({<span class="st">"rois"</span>: gdf_countries.to_crs(<span class="st">'4326'</span>)}), height<span class="op">=</span><span class="dv">800</span>, config<span class="op">=</span>config_map7)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    display(map_7)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map7.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>NOTE: the artefacts that you can see in the map above are caused by polygons crossing the antimeridian. This topic will be discussed in the next blog post of the polygon series “reference systems for polygons”.</p>
<p>This section also confirmed numerically the importance of the quality of the segmentation in taking measurements, which lead us straight to the next (and last!) section of this first tutorial about polygons.</p>
</section>
<section id="same-country-different-borders-how-different-are-they" class="level2">
<h2 class="anchored" data-anchor-id="same-country-different-borders-how-different-are-they">Same country, different borders: how different are they?</h2>
<p>The problem we want to address in this section is to quantify the differences between segmentations of the same region. As often happens in geospatial data science (and not only there) a ground truth is not available. Also, as in the case of natural phenomena, the true segmentation varies over time, and an approximation is all what we can get. Quantifying the differences between two shapes consists of reducing the dimensionality of the problem, from 2D to 1D. The methods here presented can be generalised from ND to 1D, which can happen in case altitude and time are taken into account in the segmentation process.</p>
<p>We will take three segmentations of a the Laguna Honda reservoir in San Francisco, CA: a most accurate, a less accurate, and an absurdly inaccurate one, then we measure their distances with a range of four metrics.</p>
<div id="cell-38" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dict_lh_accurate <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="op">-</span><span class="fl">122.46336870734235</span>,<span class="fl">37.75382312075932</span>],[<span class="op">-</span><span class="fl">122.46361657885608</span>,<span class="fl">37.75373534452417</span>],[<span class="op">-</span><span class="fl">122.4635831171001</span>,<span class="fl">37.75365833165909</span>],[<span class="op">-</span><span class="fl">122.46316396885612</span>,<span class="fl">37.75301643279386</span>],[<span class="op">-</span><span class="fl">122.46300520664897</span>,<span class="fl">37.752840487963525</span>],[<span class="op">-</span><span class="fl">122.46230161881246</span>,<span class="fl">37.7522463019286</span>],[<span class="op">-</span><span class="fl">122.46211503445602</span>,<span class="fl">37.75203693263166</span>],[<span class="op">-</span><span class="fl">122.46178081988387</span>,<span class="fl">37.75186782984793</span>],[<span class="op">-</span><span class="fl">122.46148855443528</span>,<span class="fl">37.75184019740165</span>],[<span class="op">-</span><span class="fl">122.46133288449474</span>,<span class="fl">37.75201341062547</span>],[<span class="op">-</span><span class="fl">122.4612061599761</span>,<span class="fl">37.752084737992796</span>],[<span class="op">-</span><span class="fl">122.46103218224685</span>,<span class="fl">37.75214417741294</span>],[<span class="op">-</span><span class="fl">122.46077014171657</span>,<span class="fl">37.752179841041794</span>],[<span class="op">-</span><span class="fl">122.46037947391036</span>,<span class="fl">37.752188392148845</span>],[<span class="op">-</span><span class="fl">122.46021718629451</span>,<span class="fl">37.75217343769624</span>],[<span class="op">-</span><span class="fl">122.4600201930734</span>,<span class="fl">37.75211950941181</span>],[<span class="op">-</span><span class="fl">122.45991172291727</span>,<span class="fl">37.75207281219638</span>],[<span class="op">-</span><span class="fl">122.45983991818758</span>,<span class="fl">37.752077610017345</span>],[<span class="op">-</span><span class="fl">122.45994274713122</span>,<span class="fl">37.75230912513596</span>],[<span class="op">-</span><span class="fl">122.45996851594319</span>,<span class="fl">37.75240437677724</span>],[<span class="op">-</span><span class="fl">122.46006708164848</span>,<span class="fl">37.7524522572354</span>],[<span class="op">-</span><span class="fl">122.46084756619754</span>,<span class="fl">37.752511150412346</span>],[<span class="op">-</span><span class="fl">122.46122218790283</span>,<span class="fl">37.75259302382214</span>],[<span class="op">-</span><span class="fl">122.46131143485962</span>,<span class="fl">37.75262966326064</span>],[<span class="op">-</span><span class="fl">122.46167022567394</span>,<span class="fl">37.7526676568636</span>],[<span class="op">-</span><span class="fl">122.46188775902073</span>,<span class="fl">37.75272257149743</span>],[<span class="op">-</span><span class="fl">122.46205025380969</span>,<span class="fl">37.752816858793715</span>],[<span class="op">-</span><span class="fl">122.462376261119</span>,<span class="fl">37.75308710607375</span>],[<span class="op">-</span><span class="fl">122.46251137863547</span>,<span class="fl">37.753166819591506</span>],[<span class="op">-</span><span class="fl">122.46262051201403</span>,<span class="fl">37.75320708721178</span>],[<span class="op">-</span><span class="fl">122.46268905680037</span>,<span class="fl">37.75326534110075</span>],[<span class="op">-</span><span class="fl">122.46270650192626</span>,<span class="fl">37.75330849493771</span>],[<span class="op">-</span><span class="fl">122.46273109980764</span>,<span class="fl">37.753422092415555</span>],[<span class="op">-</span><span class="fl">122.46277517530947</span>,<span class="fl">37.75345753879545</span>],[<span class="op">-</span><span class="fl">122.4628296309809</span>,<span class="fl">37.7534771096768</span>],[<span class="op">-</span><span class="fl">122.46294915057157</span>,<span class="fl">37.75346704465253</span>],[<span class="op">-</span><span class="fl">122.4630682867433</span>,<span class="fl">37.753516920096686</span>],[<span class="op">-</span><span class="fl">122.46336870734235</span>,<span class="fl">37.75382312075932</span>]]]}</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>dict_lh_less_accurate <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="op">-</span><span class="fl">122.46336953589098</span>,<span class="fl">37.753832862738975</span>],[<span class="op">-</span><span class="fl">122.4636233738959</span>,<span class="fl">37.75373251334907</span>],[<span class="op">-</span><span class="fl">122.4631072366194</span>,<span class="fl">37.75293640336153</span>],[<span class="op">-</span><span class="fl">122.46177458709447</span>,<span class="fl">37.75186264481159</span>],[<span class="op">-</span><span class="fl">122.46148267338904</span>,<span class="fl">37.75183922934248</span>],[<span class="op">-</span><span class="fl">122.4612246047509</span>,<span class="fl">37.752080073813296</span>],[<span class="op">-</span><span class="fl">122.46047155200345</span>,<span class="fl">37.75218711554916</span>],[<span class="op">-</span><span class="fl">122.4599004164929</span>,<span class="fl">37.752066693585995</span>],[<span class="op">-</span><span class="fl">122.45984118762517</span>,<span class="fl">37.752080073813296</span>],[<span class="op">-</span><span class="fl">122.45996387599406</span>,<span class="fl">37.752411233681165</span>],[<span class="op">-</span><span class="fl">122.46131767868594</span>,<span class="fl">37.752618625974755</span>],[<span class="op">-</span><span class="fl">122.46194804306447</span>,<span class="fl">37.75272232190355</span>],[<span class="op">-</span><span class="fl">122.46268840391157</span>,<span class="fl">37.75324748937671</span>],[<span class="op">-</span><span class="fl">122.46272647961233</span>,<span class="fl">37.753431464361086</span>],[<span class="op">-</span><span class="fl">122.46314954295359</span>,<span class="fl">37.75359536896148</span>],[<span class="op">-</span><span class="fl">122.46336953589098</span>,<span class="fl">37.753832862738975</span>]]]}</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>dict_lh_inaccurate <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="op">-</span><span class="fl">122.46176576455443</span>,<span class="fl">37.75368924488866</span>],[<span class="op">-</span><span class="fl">122.46242948841775</span>,<span class="fl">37.75334575268072</span>],[<span class="op">-</span><span class="fl">122.4631052799878</span>,<span class="fl">37.752296183276115</span>],[<span class="op">-</span><span class="fl">122.46372073302484</span>,<span class="fl">37.75144697531703</span>],[<span class="op">-</span><span class="fl">122.46259843631039</span>,<span class="fl">37.75127522420765</span>],[<span class="op">-</span><span class="fl">122.46204332180642</span>,<span class="fl">37.75167597617579</span>],[<span class="op">-</span><span class="fl">122.46192264474033</span>,<span class="fl">37.752410682480374</span>],[<span class="op">-</span><span class="fl">122.46095722821178</span>,<span class="fl">37.752954551279636</span>],[<span class="op">-</span><span class="fl">122.4605348584804</span>,<span class="fl">37.75364153773237</span>],[<span class="op">-</span><span class="fl">122.46176576455443</span>,<span class="fl">37.75368924488866</span>]]]}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>sh_lh_accurate <span class="op">=</span> shape(dict_lh_accurate)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>sh_lh_less_accurate <span class="op">=</span> shape(dict_lh_less_accurate)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>sh_lh_inaccurate <span class="op">=</span> shape(dict_lh_inaccurate)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>gdf_lh_accurate <span class="op">=</span> gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"Accurate"</span>], <span class="st">"geometry"</span>: [sh_lh_accurate]}).set_crs(<span class="st">'4326'</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>gdf_lh_less_accurate <span class="op">=</span> gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"Less accurate"</span>], <span class="st">"geometry"</span>: [sh_lh_less_accurate]}).set_crs(<span class="st">'4326'</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>gdf_lh_inaccurate <span class="op">=</span> gpd.GeoDataFrame({<span class="st">"name"</span>:[<span class="st">"Inaccurate"</span>], <span class="st">"geometry"</span>: [sh_lh_inaccurate]}).set_crs(<span class="st">'4326'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> configs <span class="im">import</span> config_map8</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    config_map8 <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    map_8 <span class="op">=</span> KeplerGl(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>{</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Laguna Honda accurate"</span>: deepcopy(gdf_lh_accurate),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Laguna Honda less accurate"</span>: deepcopy(gdf_lh_less_accurate),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Laguna Honda inaccurate"</span>: deepcopy(gdf_lh_inaccurate),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        }, </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>config_map8</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    display(map_8)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map8.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="dices-score" class="level3">
<h3 class="anchored" data-anchor-id="dices-score">Dice’s Score</h3>
<p>After Lee R. Dice, the Dice’s score measures the area of the overlap between two polygons normalised to the sum of the individual areas of the two polygons. Therefore if the polygon are perfectly congruent, then the dice equals 1, if there is no intersection between the two elements, the measure is zero.</p>
<p>Formally: let <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> be two simple (i.e.&nbsp;where their area can be computed uniquely) polygons drawn on a map, <span class="math inline">\(\mathcal{A}(P_1)\)</span> and <span class="math inline">\(\mathcal{A}(P_2)\)</span> their area, and <span class="math inline">\(P_1 \cap P_2\)</span> their intersection. The Dice’s score of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> is defined as: <span class="math display">\[
\text{Dice}(P_1, P_2) = \frac{2 \mathcal{A}(P_1 \cap P_2) }{ \mathcal{A}(P_1) + \mathcal{A}(P_2)}~.
\]</span></p>
<p>This definition does not correspond to the intuitive definition of a distance that is zero when the measured object as as close to each others as possible.</p>
</section>
<section id="dices-distance" class="level3">
<h3 class="anchored" data-anchor-id="dices-distance">Dice’s Distance</h3>
<p>The Dice’s score can be turned into a distance simply modifying its formula as: <span class="math display">\[
\text{DiceDist}(P_1, P_2) = 1 - \frac{2 \mathcal{A}(P_1 \cap P_2) }{ \mathcal{A}(P_1) + \mathcal{A}(P_2)}~,
\]</span> so that the distance between two identical polygons is zero.</p>
</section>
<section id="covariance-distance" class="level3">
<h3 class="anchored" data-anchor-id="covariance-distance">Covariance Distance</h3>
<p>We can consider the polygon’s vertex as a cloud of points, and compare the principal components of their distribution encoded as a Symmetric Positive Definite matrix through the covariance matrix.</p>
<p>The covariance distance is given by the sum of the 2 eigenvalues of the product of the covariance matrices, normalised by the sum of the products of squared eigenvalues of each covariance matrix. As done for the dice score, to have zero when the two shapes are identica, we take <span class="math inline">\(1\)</span> minus the value obtained.</p>
<p>Formally: with the same notation as above the covariance distance is defined as <span class="math display">\[
\text{CovDist}(P_1, P_2) = \alpha \left( 1 - \frac{ \text{Tr}( \text{c}(P_1) \text{c}(P_2) )  }{ \text{Fro}(P_1) + \text{Fro}(P_2)} \right) ~,
\]</span> where <span class="math inline">\(\alpha\)</span> is a multiplicative factor to scale the data (it can be one if the points are normalised with standard deviation = 1, or computed as the reciprocal of the average standard deviations of the clouds distributions), and <span class="math inline">\(\text{Tr}\)</span> and <span class="math inline">\(\text{Fro}\)</span> are the trace and Frobenius norm respectively.</p>
</section>
<section id="hausdoroff-distance" class="level3">
<h3 class="anchored" data-anchor-id="hausdoroff-distance">Hausdoroff Distance</h3>
<p>The main feature of the covariance distance is that only the principal components of the two geometries are considered, and the noise is not taken into account. The Hausdoroff distance instead aims at being very sensitive to the misplacement of a single vertex between the two geometries.</p>
<p>It’s definition is based on as maximal distance between the vertex of one polygon the distance between the <span class="math display">\[
\text{HausDist}(P_1, P_2) = \text{max} \left\{ \text{max}_{p_i \in \partial P_1} d(p_i, \partial P_2) , \text{max}_{p_j \in \partial P_2} d(p_j, \partial P_1) \right\} ~,
\]</span> where <span class="math inline">\(\partial P_1\)</span> is the contour, or perimeter of the polygon <span class="math inline">\(P_i\)</span> and <span class="math inline">\(d\)</span> is the Euclidean distance (or in the case of the curved surface, the geodesic distance).</p>
</section>
<section id="normalised-symmetric-contour-distance" class="level3">
<h3 class="anchored" data-anchor-id="normalised-symmetric-contour-distance">Normalised Symmetric Contour distance</h3>
<p>The contour distance between <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> is given by the the sum of the distances of all the vertex of <span class="math inline">\(P_1\)</span> to the contour of <span class="math inline">\(P_2\)</span>.</p>
<p>As contour distance so defined is not symmetric (the contour distance between <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> is not the same of the contour distance between <span class="math inline">\(P_2\)</span> and <span class="math inline">\(P_1\)</span>), we can make it symmetric considering the sum of the contour distance between <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> with the contour distance between <span class="math inline">\(P_2\)</span> and <span class="math inline">\(P_1\)</span>.</p>
<p>The distance can be normalised considering a distance factor encompassing both geometries in respect to their distances, which can be the lengths of both perimeters.</p>
<p>Formally: <span class="math display">\[
\text{NSCD}(P_1, P_2) = \frac{  S(P_1, P_2) + S(P_1, P_2) }{ \vert \partial P_1 \vert + \vert \partial P_2 \vert } ~,
\]</span> where the length of the contour is indicated with <span class="math inline">\(\vert \partial P_i \vert\)</span>, and <span class="math inline">\(S(P_1, P_2)\)</span> is the contour distance, computed as: <span class="math display">\[
S(P_2, P_1) = \sum_{p_i \in \partial P_1} d(p_i, \partial P_2)~.
\]</span></p>
<p>Below we implement the four distances in a class and then we use this tool to measure the distances between the polygon we created above: <code>sh_lh_accurate</code>, <code>sh_lh_less_accurate</code> and <code>sh_lh_inaccurate</code>.</p>
<p>As usual you are invited to try it out on your own, on different geometries, to check the behaviours of the distances.</p>
<div id="cell-41" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dist:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, p1: Polygon, p2: Polygon):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.p1 <span class="op">=</span> p1</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.p2 <span class="op">=</span> p2</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.prec <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dice(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="va">self</span>.p1.area <span class="op">+</span> <span class="va">self</span>.p2.area <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Polygons must have positive areas."</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">round</span>(<span class="dv">1</span> <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.p1.intersection(<span class="va">self</span>.p2).area <span class="op">/</span> (<span class="va">self</span>.p1.area <span class="op">+</span> <span class="va">self</span>.p2.area), <span class="va">self</span>.prec)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cov(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> <span class="va">self</span>.p1.exterior.coords.xy[<span class="dv">0</span>], <span class="va">self</span>.p1.exterior.coords.xy[<span class="dv">1</span>]</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        x2, y2 <span class="op">=</span> <span class="va">self</span>.p2.exterior.coords.xy[<span class="dv">0</span>], <span class="va">self</span>.p2.exterior.coords.xy[<span class="dv">1</span>]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        cov1 <span class="op">=</span> np.cov(np.array([(x1 <span class="op">-</span> np.mean(x1)) <span class="op">/</span>  np.std(x1), (y1 <span class="op">-</span> np.mean(y1)) <span class="op">/</span> np.std(y1) ]))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        cov2 <span class="op">=</span> np.cov(np.array([(x2 <span class="op">-</span> np.mean(x2)) <span class="op">/</span>  np.std(x2), (y2 <span class="op">-</span> np.mean(y2)) <span class="op">/</span> np.std(y2) ]))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">round</span>((<span class="dv">1</span> <span class="op">-</span> (np.trace(cov1.dot(cov2)) <span class="op">/</span> (np.linalg.norm(cov1, <span class="bu">ord</span><span class="op">=</span><span class="st">'fro'</span>) <span class="op">*</span> np.linalg.norm(cov2, <span class="bu">ord</span><span class="op">=</span><span class="st">'fro'</span>)))), <span class="va">self</span>.prec)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hau(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" measured in degrees !!"""</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">round</span>(<span class="va">self</span>.p1.hausdorff_distance(<span class="va">self</span>.p2), <span class="va">self</span>.prec)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> nsc(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">""" measured in degrees !!"""</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> bd(p1, p2):</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.<span class="bu">round</span>(<span class="bu">sum</span>([p1.boundary.distance(Point(x, y)) <span class="cf">for</span> x,y <span class="kw">in</span> <span class="bu">zip</span>(p2.exterior.coords.xy[<span class="dv">0</span>], p2.exterior.coords.xy[<span class="dv">1</span>])]), <span class="va">self</span>.prec)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (bd(<span class="va">self</span>.p1, <span class="va">self</span>.p2) <span class="op">+</span> bd(<span class="va">self</span>.p2, <span class="va">self</span>.p1)) <span class="op">/</span> (<span class="va">self</span>.p1.length <span class="op">+</span> <span class="va">self</span>.p2.length)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> d(<span class="va">self</span>, selected_measure: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        map_measures <span class="op">=</span> {</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"dice"</span>: <span class="va">self</span>.dice,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cov"</span>: <span class="va">self</span>.cov,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"haus"</span>: <span class="va">self</span>.hau,</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nsc"</span>: <span class="va">self</span>.nsc,</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> map_measures[selected_measure]()</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simplify the name according to the polygons colour in the image above</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>green <span class="op">=</span> sh_lh_accurate</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>yellow <span class="op">=</span> sh_lh_less_accurate</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>red <span class="op">=</span> sh_lh_inaccurate</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>meas <span class="op">=</span> [ <span class="st">"dice"</span>, <span class="st">"cov"</span>, <span class="st">"haus"</span>, <span class="st">"nsc"</span>]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>df_dist <span class="op">=</span> pd.DataFrame(</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"green - green"</span>: [Dist(green, green).d(m) <span class="cf">for</span> m <span class="kw">in</span> meas],</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"green - yellow"</span>: [Dist(green, yellow).d(m) <span class="cf">for</span> m <span class="kw">in</span> meas],</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"green - red"</span>: [Dist(green, red).d(m) <span class="cf">for</span> m <span class="kw">in</span> meas],</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yellow - red"</span>: [Dist(yellow, red).d(m) <span class="cf">for</span> m <span class="kw">in</span> meas],    </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>meas</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>)  </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>display(df_dist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">green - green</th>
<th data-quarto-table-cell-role="th">green - yellow</th>
<th data-quarto-table-cell-role="th">green - red</th>
<th data-quarto-table-cell-role="th">yellow - red</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">dice</td>
<td>-0.0</td>
<td>0.039633</td>
<td>0.760388</td>
<td>0.783997</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cov</td>
<td>0.0</td>
<td>0.000104</td>
<td>0.692591</td>
<td>0.706379</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">haus</td>
<td>0.0</td>
<td>0.000078</td>
<td>0.001526</td>
<td>0.001545</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">nsc</td>
<td>0.0</td>
<td>0.044710</td>
<td>1.657110</td>
<td>1.038613</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="note-1" class="level4">
<h4 class="anchored" data-anchor-id="note-1">Note 1:</h4>
<p>The considered Hausdorff and nsc distances are in degrees and not in meters. As we want to have a measure of the differences for geometries (specifically geometries within comparable latitude intervals) this is not invalidating the results. Though there are cases when these metrics should return the results in meters. This is left as an exercise for the reader (you can leave a comment below for a discussion about possible solutions!).</p>
</section>
<section id="note-2" class="level4">
<h4 class="anchored" data-anchor-id="note-2">Note 2:</h4>
<p>The same methods can be used for comparing the differences in shape of two objects that are expected to be similar or two measure the variability of two shapes that are changing over time, assuming that their segmentation is accurate and unbiased.</p>
<p>Also the same method can be used to measure the accuracy of a segmentation of two different people segmenting the same object (inter-rater variability) or the same person segmenting twice the same object (intra-rater variability). If the variability is assessed without the rater knowing he is segmenting twice the same shape (out of a stack of different shapes to undergo segmentation, one is repeated twice, re-labelled and re-shuffled in the stack), then this experiment is called test re-test.</p>
</section>
</section>
</section>
<section id="appendix-list-of-topics-and-further-theoretical-ideas" class="level2">
<h2 class="anchored" data-anchor-id="appendix-list-of-topics-and-further-theoretical-ideas">Appendix: list of topics and further theoretical ideas</h2>
<p>In solving three recurring problems we went through a relatively long list of topics. To maintain an hands on approach, the theory was barely touched. In the list below you can find a summary reporting the list of the topics touched and some hints to dig further into the theory:</p>
<ul>
<li>Polygons and sets
<ul>
<li>polygon as a list of vectors</li>
<li>polygon as a set on a surface</li>
<li>operations between sets: union, intersection, difference, disjoint union.</li>
<li>Can you express union and difference as combinations of intersection and disjoint union?</li>
<li>De Morgan laws</li>
<li>Mathematical concept of Algebra and sigma algebra. Are the polygons on the surface of a sphere with the operation of intersection and disjoint union a sigma algebra?</li>
<li>Geojson format to represent a polygon</li>
<li>Geojson to shapely, and shapely operations</li>
<li>Adding metadata to a polygon with geopandas</li>
<li>Osmnx library</li>
<li>Visualisation with KeplerGl and WGS84</li>
</ul></li>
<li>Morphological operations in GIS
<ul>
<li>Dilation (or buffer) and erosion</li>
<li>Bounding box</li>
<li>Convex hull</li>
<li>Class as a toolbox</li>
</ul></li>
<li>Distance between polygons and projections
<ul>
<li>“Optimal Algorithms for Computing the Minimum Distance Between Two Finite Planar Sets” Toussaint, Bhattacharya</li>
<li>Minkovsky sum</li>
<li>Haversine distance</li>
<li>Vincentry distance</li>
</ul></li>
<li>Shape differences
<ul>
<li>Segmentation</li>
<li>Difference quantification as a dimensionality reduction problem</li>
<li>Intra-rater and inter-rater variability</li>
<li>Dice’s score</li>
<li>Covariance of a polygon (of a set of 2d points) and covariance distance</li>
<li>Hausdoroff distance</li>
<li>Normalized symmetric contour distance</li>
</ul></li>
</ul>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li>Geopandas and shapely basics <a href="https://www.learndatasci.com/tutorials/geospatial-data-python-geopandas-shapely/">https://www.learndatasci.com/tutorials/geospatial-data-python-geopandas-shapely/</a></li>
<li>Shapely manual <a href="https://shapely.readthedocs.io/en/stable/manual.html">https://shapely.readthedocs.io/en/stable/manual.html</a></li>
<li>Geopandas crs usage <a href="https://geopandas.org/en/stable/docs/user_guide/projections.html">https://geopandas.org/en/stable/docs/user_guide/projections.html</a></li>
<li>intersection polygon algorithm <a href="https://www.swtestacademy.com/intersection-convex-polygons-algorithm/">https://www.swtestacademy.com/intersection-convex-polygons-algorithm/</a></li>
<li>Buffer (dilation) to remove holes <a href="https://gis.stackexchange.com/questions/409340/removing-small-holes-from-the-polygon/409398">https://gis.stackexchange.com/questions/409340/removing-small-holes-from-the-polygon/409398</a></li>
<li>maps projections <a href="https://automating-gis-processes.github.io/2017/lessons/L2/projections.html">https://automating-gis-processes.github.io/2017/lessons/L2/projections.html</a></li>
<li>Trace and covariance <a href="https://online.stat.psu.edu/stat505/lesson/1/1.5">https://online.stat.psu.edu/stat505/lesson/1/1.5</a></li>
</ul>
</section>
<section id="inspired-by" class="level2">
<h2 class="anchored" data-anchor-id="inspired-by">Inspired by</h2>
<ul>
<li><a href="https://github.com/giswqs">Qiusheng Wu</a></li>
<li><a href="https://mlabonne.github.io/blog/">Maxime Labonne</a></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Blog made with <a href="https://quarto.org/">Quarto</a>, by Sebastiano Ferraris. License: <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sebastianof/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sebastiano.ferraris@gmail.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>