<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.537">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-07-29">

<title>A Geospatial Data Science Blog - How well positioned is your office?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VPPV7D4HSQ"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-VPPV7D4HSQ', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="A Geospatial Data Science Blog - How well positioned is your office?">
<meta name="twitter:description" content="Time to question your workplace location">
<meta name="twitter:image" content="https://geospatial.netlify.app/posts/gds-2022-07-29-office-pos/images/cover_office_positioning.png">
<meta name="twitter:image-height" content="930">
<meta name="twitter:image-width" content="1663">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Geospatial Data Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-posts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Posts</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-posts">    
        <li>
    <a class="dropdown-item" href="../../posts/all.html">
 <span class="dropdown-text">All posts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/gds.html">
 <span class="dropdown-text">Geospatial Data Science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../posts/bp.html">
 <span class="dropdown-text">Code development</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../../about/about.html">
 <span class="dropdown-text">Author</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../about/CV_modern/curriculum.pdf">
 <span class="dropdown-text">CV</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sebastianof/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:sebastiano.ferraris@gmail.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">How well positioned is your office?</h1>
            <p class="subtitle lead">Time to question your workplace location</p>
                                <div class="quarto-categories">
                <div class="quarto-category">tutorial</div>
                <div class="quarto-category">data-science</div>
                <div class="quarto-category">geospatial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 29, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#how-well-positioned-is-your-office" id="toc-how-well-positioned-is-your-office" class="nav-link active" data-scroll-target="#how-well-positioned-is-your-office">How well positioned is your office?</a>
  <ul class="collapse">
  <li><a href="#problem-statement" id="toc-problem-statement" class="nav-link" data-scroll-target="#problem-statement">Problem statement</a></li>
  <li><a href="#setup-and-requirements" id="toc-setup-and-requirements" class="nav-link" data-scroll-target="#setup-and-requirements">Setup and requirements</a></li>
  <li><a href="#download-and-visualise-the-dataset" id="toc-download-and-visualise-the-dataset" class="nav-link" data-scroll-target="#download-and-visualise-the-dataset">Download and visualise the dataset</a></li>
  <li><a href="#narrow-the-dataset-to-the-city-of-london" id="toc-narrow-the-dataset-to-the-city-of-london" class="nav-link" data-scroll-target="#narrow-the-dataset-to-the-city-of-london">Narrow the dataset to the city of London</a></li>
  <li><a href="#select-the-office-location" id="toc-select-the-office-location" class="nav-link" data-scroll-target="#select-the-office-location">Select the office location</a></li>
  <li><a href="#compute-bearing-and-distance-of-all-the-commuters-to-the-selected-office" id="toc-compute-bearing-and-distance-of-all-the-commuters-to-the-selected-office" class="nav-link" data-scroll-target="#compute-bearing-and-distance-of-all-the-commuters-to-the-selected-office">Compute bearing and distance of all the commuters to the selected office</a></li>
  <li><a href="#visualise-the-results-in-a-radar-histogram-plot" id="toc-visualise-the-results-in-a-radar-histogram-plot" class="nav-link" data-scroll-target="#visualise-the-results-in-a-radar-histogram-plot">Visualise the results in a radar-histogram plot</a></li>
  <li><a href="#can-we-do-better" id="toc-can-we-do-better" class="nav-link" data-scroll-target="#can-we-do-better">Can we do better?</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources:</a></li>
  <li><a href="#also-source-of-inspiration-for-writing-this-blog-post" id="toc-also-source-of-inspiration-for-writing-this-blog-post" class="nav-link" data-scroll-target="#also-source-of-inspiration-for-writing-this-blog-post">Also source of inspiration for writing this blog post:</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/cover.png" class="img-fluid figure-img"></p>
<figcaption>Employees location respect to their office - Kepler and seaborn</figcaption>
</figure>
</div>
<p><em>This article was first published on the 24 April 2022 on <a href="https://medium.com/@sebastianof/how-well-positioned-is-your-office-8517256c497e">medium</a>. A second attempt to render both LaTeX and code was tried over <a href="https://geods.hashnode.dev">geods.hashnode.dev</a>. The current version here on quarto is the maintained one.</em></p>
<section id="how-well-positioned-is-your-office" class="level1">
<h1>How well positioned is your office?</h1>
<p>Have you ever wondered if your office has the ideal location in respect to your house and your colleagues’ houses? Imagine to discover that not only you, but also all your colleagues are located South of your office. How much time and money would all you and your colleague save if the office were to be relocated closer to where everyone lives?</p>
<p>In this blog post we explore some simple techniques from geospatial data science to investigate an instance of this problem and to visualise the situation on an interactive map.</p>
<p>You can setup your own Jupyter Notebook and python environment, and copy paste the code, or directly clone the repository from <a href="https://github.com/SebastianoF/GeoDsBlog" class="uri">https://github.com/SebastianoF/GeoDsBlog</a>.</p>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement">Problem statement</h2>
<p><a href="https://geographicdata.science/book/intro.html">Geospatial data science</a> is the branch of data science transforming geospatial data into information, insights and knowledge through the application of the scientific method and algorithms development. In this tutorial we use its principles to find the answer to a very simple question:</p>
<blockquote class="blockquote">
<p>Is your company office optimally located in respect to the position of its employees?</p>
</blockquote>
<p>Discovering that all the employees are located South in respect to the position of the office, would inform the decision of saving everyone time and money.</p>
<p>You will be using the following components:</p>
<ul>
<li>A python interpreter with the required libraries pre-installed — virtualenv or conda environment.</li>
<li>Kepler GL, for results visualisation and user queries</li>
<li>The ukcommute dataset from Keper Gl website.</li>
<li>osmnx to narrow down the dataset’s offices located within the borders of London.</li>
<li>A handful of Python functions to compute distances and angles on the surface of a sphere and to visualise some results.</li>
</ul>
<p>(all the links are provided in the next section).</p>
</section>
<section id="setup-and-requirements" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-requirements">Setup and requirements</h2>
<p>There are several options to create a python 3.9 environment. The code below uses conda:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> geods python=3.9</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate geods</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With the environment activated, install the requirements listed below:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># requirements.txt</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="va">geopandas</span><span class="op">=</span>=0.10.2</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="va">jupyter</span><span class="op">=</span>=1.0.0</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="va">keplergl</span><span class="op">=</span>=0.3.2</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">matplotlib</span><span class="op">=</span>=3.5.1</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">osmnx</span><span class="op">=</span>=1.1.2</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="va">pandas</span><span class="op">=</span>=1.4.2</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="va">seaborn</span><span class="op">=</span>=0.11.2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can install each library individually with the pip command</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="op">&lt;</span>copy paste each line here<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or you can copy paste all the <a href="https://note.nkmk.me/en/python-pip-install-requirements/">requirements</a> in a file in the root of your project <code>requirements.txt</code> and install them all in one go via:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now all should be ready and set up to go!</p>
<p>Before going to the actual code, as the interactive maps of Kepler can not be embedded in the static webpage of quarto (yet!) we set a notebook variable to suppress the KeplerGl outputs and return a screenshots instead.</p>
<p>This is to improve the appearance of the article published on the blog. You can turn the variable to <code>True</code> when running the code from the notebook, and have access to the interactive maps.</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>KEPLER_OUTPUT <span class="op">=</span> <span class="va">False</span>  <span class="co"># Render kepler output if True. Produces a screenshot otherwise</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-and-visualise-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="download-and-visualise-the-dataset">Download and visualise the dataset</h2>
<p>After importing the required library with…</p>
<div id="cell-6" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keplergl <span class="im">import</span> KeplerGl</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…we can download the chosen dataset using pandas read_csv method:</p>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># About 3 seconds</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>curl https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>keplergl<span class="op">/</span>kepler.gl<span class="op">-</span>data<span class="op">/</span>master<span class="op">/</span>ukcommute<span class="op">/</span>data.csv <span class="op">-</span>o .<span class="op">/</span>z_commuters_data.csv</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df_commuter <span class="op">=</span> pd.read_csv(<span class="st">"./z_commuters_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 28.1M  100 28.1M    0     0  1002k      0  0:00:28  0:00:28 --:--:--  789k    0     0   425k      0  0:01:07  0:00:06  0:01:01  550k0:20  0:00:11 1082k00:03 1497k   0     0   985k      0  0:00:29  0:00:27  0:00:02  878k</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_commuter.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">workplace_lng</th>
<th data-quarto-table-cell-role="th">workplace_lat</th>
<th data-quarto-table-cell-role="th">residence_lng</th>
<th data-quarto-table-cell-role="th">all_flows</th>
<th data-quarto-table-cell-role="th">residence_lat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-2.992287</td>
<td>53.410907</td>
<td>-3.016558</td>
<td>256</td>
<td>53.487704</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-3.016558</td>
<td>53.487704</td>
<td>-3.016558</td>
<td>236</td>
<td>53.487704</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-2.993589</td>
<td>53.450009</td>
<td>-3.016558</td>
<td>209</td>
<td>53.487704</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-3.026089</td>
<td>53.478898</td>
<td>-3.016558</td>
<td>188</td>
<td>53.487704</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-2.977089</td>
<td>53.406397</td>
<td>-3.016558</td>
<td>142</td>
<td>53.487704</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'version'</span>: <span class="st">'v1'</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'config'</span>: {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mapState'</span>: {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">'latitude'</span>: <span class="fl">51.536265</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">'longitude'</span>: <span class="op">-</span><span class="fl">0.039740</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">'zoom'</span>: <span class="dv">10</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    map_1 <span class="op">=</span> KeplerGl(data<span class="op">=</span>{<span class="st">'commuters'</span>: df_commuter}, config<span class="op">=</span>config, height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    display(map_1)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map1.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>At this point, you are invited to <strong>create the map on your own Jupyter notebook</strong>, to look into Kepler GL. This tool is developed by Uber, and if you have not used it before it is worth spending some time playing around with layers, colours and filters, and changing the map tiles (dark, light, satellite, etc…).</p>
<p>Kepler automatically recognises and formats the input DataFrame into independent layers, whose colour and features can be toggled and modified in the sidebar. In this case the input DataFrame is passed as a value of the input dictionary with key <code>commuters</code>, and it is, for now, the only layer.</p>
<p>For each row the dataset has two sets of points, <code>workplace</code> and <code>residence</code>, and each edge between two points on the same row is weighted by the integer column <code>all_flows</code>, that we can interpret as the number of times the commuter walked through the path over the period of the data collection. Note that this dataset has no timestamp, and from the dataset alone we can not tell the period the data was collected for.</p>
<p>Also, by observing the precision in the locations for multiple travels, and by the fact that <strong>there are workplaces in impossible locations</strong>, such as the centre of Richmond Park, we may suspect this is not real data (browse around the dataset to find more). Or if it is real data, some heavy pre-processing have happened beforehand, such as outlier detection, complete case analysis, and clustering or averaging of sets of nearby locations.</p>
<section id="a-note-on-kepler-settings" class="level4">
<h4 class="anchored" data-anchor-id="a-note-on-kepler-settings">A note on Kepler settings</h4>
<p>After changing the settings in the Kepler map, you can export them as a json <code>config</code> file with <code>map_1.config</code>, and re-import it when creating a new map. To limit the length of this post we have omitted the config used to re-create the images appearing across the post, but you can retrieve them from the <code>config</code> folder on the linked repo at:</p>
<p><a href="https://github.com/SebastianoF/GeoDsBlog/tree/master/posts/gds-2022-07-29-office-pos">https://github.com/SebastianoF/GeoDsBlog/tree/master/posts/gds-2022-07-29-office-pos</a></p>
<p>If you are not following the code from the repo, or the configs from the <code>kepler_config.py</code> module are not imported, then the cells below will be loading the previous config file as its default.</p>
</section>
</section>
<section id="narrow-the-dataset-to-the-city-of-london" class="level2">
<h2 class="anchored" data-anchor-id="narrow-the-dataset-to-the-city-of-london">Narrow the dataset to the city of London</h2>
<p>Early stage explorations indicate that the dataset covers the whole of England and Wales. Also toggling the layers, or making the workplace radii smaller and selecting a different colorscale than the residences, we can see that in many cases some <strong>some workplaces are coincident with the residences</strong>. For the moment, and for the goals of this post, this problem is of no concern.</p>
<p>As what we want to do is to assess the <strong>optimality of a location within the boundaries of London</strong>, the first thing to do is to download the city boundaries and then reduce the dataset to the offices located within these boundaries.</p>
<p>The geometry of a boundary can be encoded as a shapely polygon, and embedded into a <strong>geopandas dataframe</strong>: a pandas dataframe equipped with a column named <code>geometry</code> containing a shapely object. We can download the polygon from <strong>Open Street Map</strong>, the open source initiative providing the users with a free editable geographic database of the world.</p>
<p>Fear not, you are not asked to open a new tab on the browser and download the maps from the osm website! The maps can be downloaded programmatically via the very handy <code>osmnx</code> python library, and via its method <code>osmnx.geocode_to_gdf</code>.</p>
<p>Note that we will query both <strong>London</strong> and the <strong>City of London</strong> geometries, in order to filter the workplace points in our dataset appearing in the union of these two regions.</p>
<div id="cell-14" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>osmnx.config(use_cache<span class="op">=</span><span class="va">True</span>, log_console<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gdf_concat(list_gdf: <span class="bu">list</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpd.GeoDataFrame( pd.concat(list_gdf, ignore_index<span class="op">=</span><span class="va">True</span>)) </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>query_city <span class="op">=</span> {<span class="st">'city'</span>: <span class="st">'City of London'</span>}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>query_london <span class="op">=</span> {<span class="st">'city'</span>: <span class="st">'London'</span>}</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf_concat([osmnx.geocode_to_gdf(query_city), osmnx.geocode_to_gdf(query_london)])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">bbox_north</th>
<th data-quarto-table-cell-role="th">bbox_south</th>
<th data-quarto-table-cell-role="th">bbox_east</th>
<th data-quarto-table-cell-role="th">bbox_west</th>
<th data-quarto-table-cell-role="th">place_id</th>
<th data-quarto-table-cell-role="th">osm_type</th>
<th data-quarto-table-cell-role="th">osm_id</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">place_rank</th>
<th data-quarto-table-cell-role="th">importance</th>
<th data-quarto-table-cell-role="th">addresstype</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">display_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POLYGON ((-0.11383 51.51826, -0.11380 51.51812...</td>
<td>51.523312</td>
<td>51.506871</td>
<td>-0.072762</td>
<td>-0.113830</td>
<td>243916402</td>
<td>relation</td>
<td>51800</td>
<td>51.515618</td>
<td>-0.091998</td>
<td>boundary</td>
<td>administrative</td>
<td>12</td>
<td>0.586511</td>
<td>city</td>
<td>City of London</td>
<td>City of London, Greater London, England, Unite...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POLYGON ((-0.51038 51.46809, -0.51036 51.46795...</td>
<td>51.691874</td>
<td>51.286760</td>
<td>0.334016</td>
<td>-0.510375</td>
<td>243408926</td>
<td>relation</td>
<td>65606</td>
<td>51.507446</td>
<td>-0.127765</td>
<td>place</td>
<td>city</td>
<td>16</td>
<td>0.830783</td>
<td>city</td>
<td>London</td>
<td>London, Greater London, England, United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Before continuing, it would be good to visualise the polygons we just downloaded. There are multiple ways to do this. For example we can use <em>contextility</em> as a basemap and use the embedded method plot of a geopandas dataframe.</p>
<div id="cell-16" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gdf_epsg <span class="op">=</span> gdf.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> gdf_epsg.plot(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, source<span class="op">=</span>cx.providers.CartoDB.DarkMatterNoLabels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> kepler_config <span class="im">import</span> config_map_2</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> config_map_2</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    map_2 <span class="op">=</span> KeplerGl(data<span class="op">=</span>{<span class="st">'london'</span> :gdf_epsg}, config<span class="op">=</span>config, height<span class="op">=</span><span class="dv">800</span>)  <span class="co"># kepler knows what to do when fed with a geodataframe</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    display(map_2)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map2.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To narrow the commuter dataset to only the offices within the boundary of London, first we cast <code>df_commuter</code> into a geopandas DataFrame with the geometry column having for each entry the shapely point of the workplace coordinate.</p>
<p>Then we use this new geodataframe to obtain the mask of the point within the boundaries, and finally we apply the mask to the initial <code>df_commuter</code> dataset. Since we are here, we also take a look at the percentage of the offices that are in London over the full dataset (you are of course invited to look into other statistics).</p>
<div id="cell-19" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- about 17 seconds --</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>gdf_commuters_workplace <span class="op">=</span> gpd.GeoDataFrame(df_commuter.copy(), geometry<span class="op">=</span>gpd.points_from_xy(df_commuter.workplace_lng, df_commuter.workplace_lat))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -- about 120 seconds: points in polygon </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>mask_points_in_city <span class="op">=</span> gdf_commuters_workplace.intersects(gdf.geometry.iloc[<span class="dv">0</span>])</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>mask_points_in_london <span class="op">=</span> gdf_commuters_workplace.intersects(gdf.geometry.iloc[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>num_total_rows <span class="op">=</span> <span class="bu">len</span>(gdf_commuters_workplace)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>num_rows_in_city <span class="op">=</span> <span class="bu">len</span>(mask_points_in_city[mask_points_in_city])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>num_rows_in_london <span class="op">=</span> <span class="bu">len</span>(mask_points_in_london[mask_points_in_london])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of rows for offices in the city </span><span class="sc">{</span>num_rows_in_city<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> num_rows_in_city <span class="op">/</span> num_total_rows<span class="sc">}</span><span class="ss"> %)"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of rows for offices in london </span><span class="sc">{</span>num_rows_in_london<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> num_rows_in_london <span class="op">/</span> num_total_rows<span class="sc">}</span><span class="ss"> %)"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>mask_union <span class="op">=</span> mask_points_in_city <span class="op">|</span> mask_points_in_london</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>num_rows_in_union <span class="op">=</span> mask_union.<span class="bu">sum</span>()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of offices in the union of London and the City </span><span class="sc">{</span>num_rows_in_union<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> num_rows_in_union <span class="op">/</span> num_total_rows<span class="sc">}</span><span class="ss"> %)"</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> num_rows_in_union <span class="op">==</span> num_rows_in_city <span class="op">+</span> num_rows_in_london</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>df_commuter_london_office <span class="op">=</span> df_commuter[mask_union]</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>df_commuter_london_office.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>df_commuter_london_office.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of rows for offices in the city 4507 (0.663142267337411 %)
Number of rows for offices in london 139512 (20.52724739311668 %)
Number of offices in the union of London and the City 144019 (21.19038966045409 %)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">workplace_lng</th>
<th data-quarto-table-cell-role="th">workplace_lat</th>
<th data-quarto-table-cell-role="th">residence_lng</th>
<th data-quarto-table-cell-role="th">all_flows</th>
<th data-quarto-table-cell-role="th">residence_lat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.096124</td>
<td>51.502618</td>
<td>-2.258075</td>
<td>14</td>
<td>53.406096</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.064385</td>
<td>51.490614</td>
<td>-1.633650</td>
<td>11</td>
<td>54.380373</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.064385</td>
<td>51.490614</td>
<td>-1.731036</td>
<td>27</td>
<td>54.408769</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.094986</td>
<td>51.519522</td>
<td>-1.818510</td>
<td>14</td>
<td>53.925985</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.094986</td>
<td>51.519522</td>
<td>-1.081245</td>
<td>14</td>
<td>53.958359</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> kepler_config <span class="im">import</span> config_map_3</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    config_map_3 <span class="op">=</span> config</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the config_3 in kepler_config.py in the repo to reproduce the same image</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    map_3 <span class="op">=</span> KeplerGl(data<span class="op">=</span>{<span class="st">'london'</span>:gdf_epsg.copy(),  <span class="st">"commuters"</span>: df_commuter_london_office.copy()}, config<span class="op">=</span>config_map_3, height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    display(map_3)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map3.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As noted before, many of the workplaces and residences have the same coordinates and are overlapping on the map. Also in the dataset reduced to the boundaries of London residences and offices are overlapping, but outside the boundary, as expected, there are only residences.</p>
</section>
<section id="select-the-office-location" class="level2">
<h2 class="anchored" data-anchor-id="select-the-office-location">Select the office location</h2>
<p>Now the goal is to select a single office of interest (or a group of nearby offices), and to examine its location in respect to the location of the employees. The functionality of drawing polygons provided by Kepler Gl comes in handy for this purpose.</p>
<p>On the top right menu, selecting the “draw on map” button we can narrow down a region and copy its geometry to clipboard right-clicking on the completed polygon. We can then paste the geometry in the cell of our Jupyter notebook.</p>
<p>The geometry, encoded in a json, can be then parsed into a <strong>shapely polygon</strong>.</p>
<p>As an example we copy pasted two polygons in the cell below (you are invited to continue the tutorial with your own regions though!). The first one encompasses an office in St Luke’s Close, the closest office to the silicon roundabout, Old Street, and the second one in Albert Road, just between the London city airport and the river Thames.</p>
<div id="cell-24" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>polygon_st_luke_office <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="op">-</span><span class="fl">0.0930210043528368</span>,<span class="fl">51.52553386809767</span>],[<span class="op">-</span><span class="fl">0.09362754938510826</span>,<span class="fl">51.5257442611004</span>],[<span class="op">-</span><span class="fl">0.09398505401347826</span>,<span class="fl">51.52546150215205</span>],[<span class="op">-</span><span class="fl">0.09363181940230854</span>,<span class="fl">51.525218817282784</span>],[<span class="op">-</span><span class="fl">0.09313761642997592</span>,<span class="fl">51.52527679524477</span>],[<span class="op">-</span><span class="fl">0.0930210043528368</span>,<span class="fl">51.52553386809767</span>]]]}</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>polygon_albert_road <span class="op">=</span> {<span class="st">"type"</span>:<span class="st">"Polygon"</span>,<span class="st">"coordinates"</span>:[[[<span class="fl">0.05074120549614755</span>,<span class="fl">51.503014231092195</span>],[<span class="fl">0.04882522609357891</span>,<span class="fl">51.50189434877025</span>],[<span class="fl">0.051410997081145014</span>,<span class="fl">51.49996117091324</span>],[<span class="fl">0.05337913172491038</span>,<span class="fl">51.501678115383754</span>],[<span class="fl">0.05074120549614755</span>,<span class="fl">51.503014231092195</span>]]]}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we narrow the office locations to the selected geometry, embed the geometry in a geopandas DataFrame, and feed the result to a Kepler map to visualise where we are at.</p>
<div id="cell-26" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># narrow dataset to the geometry</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>mask_st_luke_office <span class="op">=</span> gdf_commuters_workplace.intersects(shape(polygon_st_luke_office))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>df_commuters_st_luke_office <span class="op">=</span> df_commuter[mask_st_luke_office]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># embed shape into a geopandas to visualise in kepler</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>gdf_st_luke_geometry <span class="op">=</span> gpd.GeoDataFrame({<span class="st">'geometry'</span>:[shape(polygon_st_luke_office)], <span class="st">"display_name"</span>: [<span class="st">"St Luke's Close Office"</span>]})</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Same for Albert Road office</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>mask_albert_road <span class="op">=</span> gdf_commuters_workplace.intersects(shape(polygon_albert_road))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>df_commuters_albert_road <span class="op">=</span> df_commuter[mask_albert_road]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>gdf_albert_road <span class="op">=</span> gpd.GeoDataFrame({<span class="st">'geometry'</span>:[shape(polygon_albert_road)], <span class="st">"display_name"</span>: [<span class="st">"St Luke's Close Office"</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> kepler_config <span class="im">import</span> config_map_4</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    config_map_4 <span class="op">=</span> config</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> KEPLER_OUTPUT:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    map_4 <span class="op">=</span> KeplerGl(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>{</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"St Luke's Close Office"</span>: gdf_st_luke_geometry.copy(),  </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"commuters to St Luke"</span>: df_commuters_st_luke_office.copy(),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Albert Road Office"</span>: gdf_albert_road.copy(),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"commuters to Albert"</span>: df_commuters_albert_road.copy(),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        }, </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>config_map_4, </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span>)  <span class="co"># kepler knows what to do when fed with a geodataframe</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    display(map_4)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    display(Image(<span class="st">"images/map4.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Commuters to St Luke office </span><span class="sc">{</span><span class="bu">len</span>(df_commuters_st_luke_office)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> <span class="bu">len</span>(df_commuters_st_luke_office) <span class="op">/</span> <span class="bu">len</span>(df_commuter), <span class="dv">4</span>)<span class="sc">}</span><span class="ss"> %)"</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Commuters to Albert Road office </span><span class="sc">{</span><span class="bu">len</span>(df_commuters_albert_road)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span>  <span class="bu">len</span>(df_commuters_albert_road) <span class="op">/</span> <span class="bu">len</span>(df_commuter), <span class="dv">4</span>)<span class="sc">}</span><span class="ss"> %)"</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Commuters to St Luke office 2197 (0.3233 %)
Commuters to Albert Road office 225 (0.0331 %)</code></pre>
</div>
</div>
</section>
<section id="compute-bearing-and-distance-of-all-the-commuters-to-the-selected-office" class="level2">
<h2 class="anchored" data-anchor-id="compute-bearing-and-distance-of-all-the-commuters-to-the-selected-office">Compute bearing and distance of all the commuters to the selected office</h2>
<p>Now that we have the dataset of commuters to two custom selected offices in London, we want to compute the bearing and distance from the office to each employees residence.</p>
<p>There are multiple ways to achieve this result, such as using one of the many python libraries, as haversine, geopy, geographiclib… As our goal is to learn some tools from geodata science, we will try to implement the formulae from scratch.</p>
<p>Given two points (lng1, lat1) and (lng2, lat2), the Haversine formula (geodesic distance on the sphere) is given by:</p>
<p><span class="math display">\[
\mathcal{H} = 2 R \arcsin\left(\sqrt{d}\right)
\]</span></p>
<p>where</p>
<p><span class="math display">\[
d = \sin^2 \left(\frac{\Delta \text{lat}}{2} \right) + \cos(\text{lat1}) \cos(\text{lat2})  \sin^2\left(\frac{\Delta \text{lon}}{2}\right)
\]</span></p>
<p>and <span class="math inline">\(\Delta \text{lat} = \text{lat1} - \text{lat2}\)</span>, <span class="math inline">\(\Delta \text{lon} = \text{lon1} - \text{lon2}\)</span>, and <span class="math inline">\(R\)</span> is the hearth’s radius<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>The formula for the bearing, as the angle formed by the geodesics between the north pole and (lng1, lat1), and the geodesic between (lng1, lat1) and (lng2, lat2) is, in radiants:</p>
<p><span class="math display">\[
\mathcal{B} = \arctan\left(
    \frac{
        \sin(\Delta \text{lon}) \cos(\text{lat2})
    }{
        \cos(\text{lat1}) \sin(\text{lat2}) - \sin(\text{lat1}) \cos(\text{lat2}) \cos\left( \Delta \text{lon} \right)
    }
\right)
\]</span></p>
<p>Both formulae are based on the spherical model, which is a reasonable approximation, though in geospatial data science the standard model is the ellipsoid model <strong>World Geodesics System 1984 (WGS84)</strong>, where the distance between the centre and the equator is higher than the distance between the centre and the poles by about 31 Km.</p>
<p>Exposing the reason why these formulae above are correct, and generalising them for the WGS84 model (the Vincenty’s formulae), would entail expanding the blog post beyond reason. This topic is therefore left as future work, or to the reader.</p>
<div id="cell-30" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> haversine(lng1: <span class="bu">float</span>, lat1: <span class="bu">float</span>, lng2: <span class="bu">float</span>, lat2: <span class="bu">float</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" returns (haversine distance in km, bearing in degrees from point 1 to point 2), vectorised """</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    avg_earth_radius_km <span class="op">=</span> <span class="fl">6371.0072</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    lng1, lat1, lng2, lat2 <span class="op">=</span> <span class="bu">map</span>(np.deg2rad, [lng1, lat1, lng2, lat2])</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    d_lat, d_lng <span class="op">=</span> lat2 <span class="op">-</span> lat1, lng2 <span class="op">-</span> lng1</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> np.sin((d_lat)<span class="op">/</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> np.cos(lat1)<span class="op">*</span>np.cos(lat2) <span class="op">*</span> np.sin((d_lng)<span class="op">/</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    hav_dist <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> avg_earth_radius_km <span class="op">*</span> np.arcsin(np.sqrt(d))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.sin(d_lng) <span class="op">*</span> np.cos(lat2)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.cos(lat1) <span class="op">*</span> np.sin(lat2) <span class="op">-</span> np.sin(lat1) <span class="op">*</span> np.cos(lat2) <span class="op">*</span> np.cos(d_lng)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    bearing <span class="op">=</span> (np.arctan2(y, x) <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">%</span> (<span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hav_dist, np.rad2deg(bearing)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_bearing_deg_and_distance_km(df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""bearing between A and B is the angle between the geodesics connecting A and the north pole, and the geodesics connecting A and B.</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Both the bearing and distance are computed on the Spherical model.</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    lng_work, lat_work <span class="op">=</span> df.workplace_lng.to_numpy(), df.workplace_lat.to_numpy()</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    lng_home, lat_home <span class="op">=</span> df.residence_lng.to_numpy(), df.residence_lat.to_numpy()</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"distance_km"</span>], df[<span class="st">"bearing_deg"</span>] <span class="op">=</span> haversine(lng_work, lat_work, lng_home, lat_home)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_commuters_st_luke_office <span class="op">=</span> add_bearing_deg_and_distance_km(df_commuters_st_luke_office)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df_commuters_albert_road <span class="op">=</span> add_bearing_deg_and_distance_km(df_commuters_albert_road)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>display(df_commuters_st_luke_office.head())</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>display(df_commuters_albert_road.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">workplace_lng</th>
<th data-quarto-table-cell-role="th">workplace_lat</th>
<th data-quarto-table-cell-role="th">residence_lng</th>
<th data-quarto-table-cell-role="th">all_flows</th>
<th data-quarto-table-cell-role="th">residence_lat</th>
<th data-quarto-table-cell-role="th">distance_km</th>
<th data-quarto-table-cell-role="th">bearing_deg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">122746</td>
<td>-0.093427</td>
<td>51.525514</td>
<td>0.100309</td>
<td>14</td>
<td>51.669006</td>
<td>20.824387</td>
<td>39.910497</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">122840</td>
<td>-0.093427</td>
<td>51.525514</td>
<td>0.081235</td>
<td>16</td>
<td>51.654781</td>
<td>18.767046</td>
<td>39.943704</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">122960</td>
<td>-0.093427</td>
<td>51.525514</td>
<td>0.013113</td>
<td>15</td>
<td>51.683825</td>
<td>19.079225</td>
<td>22.642044</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">123150</td>
<td>-0.093427</td>
<td>51.525514</td>
<td>0.112969</td>
<td>21</td>
<td>51.694097</td>
<td>23.548401</td>
<td>37.165113</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">123277</td>
<td>-0.093427</td>
<td>51.525514</td>
<td>0.243324</td>
<td>13</td>
<td>51.708458</td>
<td>30.893113</td>
<td>48.684224</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">workplace_lng</th>
<th data-quarto-table-cell-role="th">workplace_lat</th>
<th data-quarto-table-cell-role="th">residence_lng</th>
<th data-quarto-table-cell-role="th">all_flows</th>
<th data-quarto-table-cell-role="th">residence_lat</th>
<th data-quarto-table-cell-role="th">distance_km</th>
<th data-quarto-table-cell-role="th">bearing_deg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">123573</td>
<td>0.05024</td>
<td>51.502045</td>
<td>0.069103</td>
<td>10</td>
<td>51.642368</td>
<td>15.657587</td>
<td>4.768539</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">127534</td>
<td>0.05024</td>
<td>51.502045</td>
<td>0.321880</td>
<td>12</td>
<td>51.474405</td>
<td>19.057378</td>
<td>99.174466</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">127640</td>
<td>0.05024</td>
<td>51.502045</td>
<td>0.365564</td>
<td>13</td>
<td>51.464030</td>
<td>22.240404</td>
<td>100.833071</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">127928</td>
<td>0.05024</td>
<td>51.502045</td>
<td>0.252849</td>
<td>15</td>
<td>51.482116</td>
<td>14.201101</td>
<td>98.898103</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">128083</td>
<td>0.05024</td>
<td>51.502045</td>
<td>0.327369</td>
<td>12</td>
<td>51.479152</td>
<td>19.355094</td>
<td>97.449008</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="visualise-the-results-in-a-radar-histogram-plot" class="level2">
<h2 class="anchored" data-anchor-id="visualise-the-results-in-a-radar-histogram-plot">Visualise the results in a radar-histogram plot</h2>
<p>For an distance and bearing effective visualisation, a circular histogram would do what we need. The polar visualisation of matplotlib will do this for us.</p>
<p>We group the dataset into three categories, according to their radial distance from the office: - Within a radius of 10 Km - Between 10Km and 20 Km - Above 20 Km</p>
<p>Then we compute the histograms in <strong>polar coordinates</strong>. As we have to do it for two different dataset, instead of repeating the same code twice, we embed the transformation and visualisation in a single function.</p>
<p>Within the same function there is some repeated code for each radius. It is left to you to embed the repeated code in a <code>for</code> cycle for the <code>inner</code>, <code>between</code> and <code>outer</code> histogram, and to generalise it to any number of radii and distances.</p>
<p>As a further exercise, separating the data pre-processing and the visualisation part in two different function would be better practice than keeping both steps in the same function.</p>
<div id="cell-34" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"darkgrid"</span>, {<span class="st">"grid.color"</span>: <span class="st">".6"</span>, <span class="st">"grid.linestyle"</span>: <span class="st">":"</span>})</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> radar_histogram(ax, df):</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Input: </span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">        df with at least 2 columns distance_km and bearing_deg.</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Output: radar histogram plot.</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figures parameter</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    directions <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    bottom <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    height_scale <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bearing: degrees from nort pole clockwise</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    bearing_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">360</span>, directions<span class="op">+</span><span class="dv">1</span>, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># angle visualisation: rad from east counterclockwise</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">*</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, directions, endpoint<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> np.pi<span class="op">/</span><span class="dv">2</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">/</span> directions</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data binning</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    se_bins <span class="op">=</span> pd.cut(df[<span class="st">"bearing_deg"</span>].to_numpy(), bearing_bins)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    np_bins <span class="op">=</span> se_bins.value_counts().to_numpy()</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span>  height_scale <span class="op">*</span> np.array(np_bins) <span class="op">/</span> np.<span class="bu">max</span>(np_bins)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uncomment to debug figure:</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bins = range(directions)</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plotting    </span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> ax.bar(theta, bins, width<span class="op">=</span>width, bottom<span class="op">=</span>bottom, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([])</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, <span class="dv">8</span>, endpoint<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="st">'E'</span>, <span class="st">''</span>, <span class="st">'N'</span>, <span class="st">''</span>, <span class="st">'W'</span>, <span class="st">''</span>, <span class="st">'S'</span>, <span class="st">''</span>])</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">False</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> radar_histogram_3_levels(ax, df):</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Input: </span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="co">        df with at least 2 columns distance_km and bearing_deg.</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Output: radar histogram plot.</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figures parameter</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    directions <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    height_scale <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    bottom_inner <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    bottom_betw <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    bottom_outer <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bearing: degrees from nort pole clockwise</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    bearing_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">360</span>, directions<span class="op">+</span><span class="dv">1</span>, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># angle visualisation: rad from east counterclockwise</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">*</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, directions, endpoint<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> np.pi<span class="op">/</span><span class="dv">2</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">/</span> directions</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data binning</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    df_inner <span class="op">=</span> df[df[<span class="st">"distance_km"</span>] <span class="op">&lt;=</span> <span class="dv">10</span>]</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    se_bins_inner <span class="op">=</span> pd.cut(df_inner[<span class="st">"bearing_deg"</span>].to_numpy(), bearing_bins)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    np_bins_inner <span class="op">=</span> se_bins_inner.value_counts().to_numpy()</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    bins_inner <span class="op">=</span>  height_scale <span class="op">*</span> np.array(np_bins_inner) <span class="op">/</span> np.<span class="bu">max</span>(np_bins_inner)</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    df_betw <span class="op">=</span> df[(df[<span class="st">"distance_km"</span>] <span class="op">&gt;</span> <span class="dv">10</span>) <span class="op">&amp;</span> (df[<span class="st">"distance_km"</span>] <span class="op">&lt;=</span> <span class="dv">20</span>)]</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    se_bins_betw <span class="op">=</span> pd.cut(df_betw[<span class="st">"bearing_deg"</span>].to_numpy(), bearing_bins)</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    np_bins_betw <span class="op">=</span> se_bins_betw.value_counts().to_numpy()</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    bins_betw <span class="op">=</span>  height_scale <span class="op">*</span> np.array(np_bins_betw) <span class="op">/</span> np.<span class="bu">max</span>(np_bins_betw)</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    df_outer <span class="op">=</span> df[df[<span class="st">"distance_km"</span>] <span class="op">&gt;</span> <span class="dv">20</span>]</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    se_bins_outer <span class="op">=</span> pd.cut(df_outer[<span class="st">"bearing_deg"</span>].to_numpy(), bearing_bins)</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>    np_bins_outer <span class="op">=</span> se_bins_outer.value_counts().to_numpy()</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>    bins_outer <span class="op">=</span>  height_scale <span class="op">*</span> np.array(np_bins_outer) <span class="op">/</span> np.<span class="bu">max</span>(np_bins_outer)</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plotting</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> ax.bar(theta, bins_inner, width<span class="op">=</span>width, bottom<span class="op">=</span>bottom_inner, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> ax.bar(theta, bins_betw, width<span class="op">=</span>width, bottom<span class="op">=</span>bottom_betw, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> ax.bar(theta, bins_outer, width<span class="op">=</span>width, bottom<span class="op">=</span>bottom_outer, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([])</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># uncomment to add values on radius axis</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax.set_yticks(np.arange(0,10,1.0))</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax.set_yticklabels(['', '', '', '&lt;=10Km ', '', '', '&gt;10Km\n &lt;=20Km', '', '', '&gt;20Km'])</span></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi, <span class="dv">8</span>, endpoint<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="st">'E'</span>, <span class="st">''</span>, <span class="st">'N'</span>, <span class="st">''</span>, <span class="st">'W'</span>, <span class="st">''</span>, <span class="st">'S'</span>, <span class="st">''</span>])</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">False</span>)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ax11 <span class="op">=</span> fig.add_subplot(<span class="dv">221</span>, polar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>ax11 <span class="op">=</span> radar_histogram(ax11, df_commuters_st_luke_office)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>ax11.set_title(<span class="st">"Saint Luke Office"</span>, y<span class="op">=</span><span class="fl">1.08</span>, x<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>ax12 <span class="op">=</span> fig.add_subplot(<span class="dv">222</span>, polar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>ax12 <span class="op">=</span> radar_histogram_3_levels(ax12, df_commuters_st_luke_office)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>ax21 <span class="op">=</span> fig.add_subplot(<span class="dv">223</span>, polar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>ax21 <span class="op">=</span> radar_histogram(ax21, df_commuters_albert_road)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>ax21.set_title(<span class="st">"Albert Road Office"</span>, y<span class="op">=</span><span class="fl">1.08</span>, x<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>ax22 <span class="op">=</span> fig.add_subplot(<span class="dv">224</span>, polar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>ax22 <span class="op">=</span> radar_histogram_3_levels(ax22, df_commuters_albert_road)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>plt.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Radar histogram plot with the distribution of the location of the employees respect to the office, at the centre of the diagram. In the first column all the residences are shown regardless of the distance from the centre. In the second column the residences are split by distance from the centre: inner circle &lt; 10Km, mid circle between 10 and 20 Km, outer circle &gt; 20 Km.</p>
<p>From the graphs above we can see that the office in Saint Luke is reasonably well balance across the location of the employees, overall, and splitting the commuters into three categories based on radial distance.</p>
<p>The same can not be said for the office located in Albert road office, whose employees should consider to relocate to an office further North-East.</p>
</section>
<section id="can-we-do-better" class="level2">
<h2 class="anchored" data-anchor-id="can-we-do-better">Can we do better?</h2>
<p>From the question “Is your company office optimally located in respect to the position of its employees?”, we developed a small example of the geospatial data science capabilities to visualise the employees distribution around in respect to the position of their office, via the computation of bearing and distance, to see how off-center it can be, and in which direction it should be relocated to reduce the commuting distance for each employee. In doing so we showed how to download city boundaries from the OSM python API, how to intersect points in polygons, and how visualise geospatial data with Keplerl GL.</p>
<p>There are several limitations that are worth mentioning. The first and most obvious one is that the bearing and distance between office and residence is not a the single metric to justify an office relocation. From the point of view of the employee, there are other factors that have not been considered, such as commuting time, cost, frequency of commute, as well as the employee position in the company hierarchy and its “can’t bother” factor. This last metric, is an empirical one of the will (or lack thereof) to make a change, it is entirely based upon the individual opinion, taking into account for example possible facilities in the new office, traffic, proximity to children’s schools and so on. All these parameters has to be considered for the current office location and the potential new office location.</p>
<p>From the point of view of the employer, there is of course the cost of the new office, as well as the cost of the move, as well as prestige of location in respect to possible investors.</p>
<p>The last limitation is obviously the dataset. The whole post was written around the toy dataset downloaded from the of Kepler GL examples page. Is it realistic enough or reliable? Can we for example make further analysis on the dataset and obtain some statistics and insights about commuters’ habits? We already noticed that some, if not all commuting locations coincided with the location of the offices. Can we do some further analysis to know how little we should trust the data? To answer this question, we can end up with some minimal data analysis to the dataset to see if the ratio of number of offices in respect to the number of employees is convincing.</p>
<div id="cell-39" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>number_of_offices <span class="op">=</span> <span class="bu">len</span>(df_commuter.groupby([<span class="st">"workplace_lng"</span>, <span class="st">"workplace_lat"</span>]).count())</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>number_of_residences <span class="op">=</span> <span class="bu">len</span>(df_commuter.groupby([<span class="st">"residence_lng"</span>, <span class="st">"residence_lat"</span>]).count())</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>number_of_offices_in_london_and_city <span class="op">=</span> <span class="bu">len</span>(df_commuter_london_office.groupby([<span class="st">"workplace_lng"</span>, <span class="st">"workplace_lat"</span>]).count())</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>number_of_residences_commuting_to_london_and_city <span class="op">=</span> <span class="bu">len</span>(df_commuter_london_office.groupby([<span class="st">"residence_lng"</span>, <span class="st">"residence_lat"</span>]).count())</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>commuters_office_ratio <span class="op">=</span> number_of_residences <span class="op">/</span> number_of_offices</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>commuters_office_ratio_in_london_and_city <span class="op">=</span> number_of_residences_commuting_to_london_and_city <span class="op">/</span> number_of_offices_in_london_and_city</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Number of offices in london and the city </span><span class="sc">{</span>number_of_offices_in_london_and_city<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> number_of_offices_in_london_and_city <span class="op">/</span> number_of_offices, <span class="dv">4</span>)<span class="sc">}</span><span class="ss"> %)"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Number of residences commuting to london and the city </span><span class="sc">{</span>number_of_residences_commuting_to_london_and_city<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(<span class="dv">100</span> <span class="op">*</span> number_of_residences_commuting_to_london_and_city <span class="op">/</span> number_of_residences, <span class="dv">4</span>)<span class="sc">}</span><span class="ss"> %)"</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Number of commuters residences per office </span><span class="sc">{</span>commuters_office_ratio<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Number of commuters residences per office in london and the city </span><span class="sc">{</span><span class="bu">round</span>(commuters_office_ratio_in_london_and_city, <span class="dv">4</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of offices in london and the city 983 (13.6509 %)
Number of residences commuting to london and the city 2678 (37.1893 %)
Number of commuters residences per office 1.0
Number of commuters residences per office in london and the city 2.7243</code></pre>
</div>
</div>
<p>Certainly the ratio of commuter’s residences per office can tell us that there is something wrong with the dataset. We could speculated about the fact that the dataset is synthetically generated, or that the arrows direction was swapped when generating the dataset, or both. With no further information, we can only say that no analysis on this dataset can provide us with any reasonable answers or statistics to questions related to commuters in the UK. Nonetheless it is a useful dataset for visualistaion and toy exercises such as the one just presented.</p>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources:</h2>
<ul>
<li>https://geopandas.org/en/stable/index.html</li>
<li>https://stackoverflow.com/questions/65064351/python-osmnx-how-to-download-a-city-district-map-from-openstreetmap-based-on-t</li>
<li>https://gis.stackexchange.com/questions/343725/convert-geojson-to-geopandas-geodataframe</li>
<li>https://stackoverflow.com/questions/4913349/haversine-formula-in-python-bearing-and-distance-between-two-gps-points</li>
<li>https://anitagraser.github.io/movingpandas/</li>
<li>https://stackoverflow.com/questions/17624310/geopy-calculating-gps-heading-bearing</li>
<li>https://geodesy.noaa.gov/CORS/</li>
<li>https://stackoverflow.com/questions/22562364/circular-polar-histogram-in-python</li>
<li>https://stackoverflow.com/questions/12750355/python-matplotlib-figure-title-overlaps-axes-label-when-using-twiny</li>
<li>https://www.dexplo.org/jupyter_to_medium/</li>
</ul>
</section>
<section id="also-source-of-inspiration-for-writing-this-blog-post" class="level2">
<h2 class="anchored" data-anchor-id="also-source-of-inspiration-for-writing-this-blog-post">Also source of inspiration for writing this blog post:</h2>
<ul>
<li><a href="https://mlabonne.github.io/blog/">Maxime Labonne</a></li>
<li><a href="https://khuyentran1476.medium.com/">Khuyen Tran</a></li>
<li><a href="https://medium.com/@shakasom">Abdishakur</a></li>
<li><a href="https://herbertlui.medium.com/">Herbert Lui</a></li>
<li><a href="https://medium.com/@maciejtarsa">Maciej Tarsa</a></li>
</ul>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Details about how to prove and compute the Haversine function can be found in the blog post <a href="https://geospatial.netlify.app/posts/gds-2024-01-10-haversine-dist/" class="uri">https://geospatial.netlify.app/posts/gds-2024-01-10-haversine-dist/</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Blog made with <a href="https://quarto.org/">Quarto</a>, by Sebastiano Ferraris. License: <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sebastianof/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sebastiano.ferraris@gmail.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>